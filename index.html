<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPYFALL - í†µí•© ë²„ì „</title>
    
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc; 
            -webkit-tap-highlight-color: transparent; 
            overflow: hidden; 
            height: 100vh;
        }
        .spy-bg { 
            background: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #0f172a 60%, #020617 100%);
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .glow-blue { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); border-color: #3b82f6; }
        .glow-orange { box-shadow: 0 0 15px rgba(249, 115, 22, 0.5); border-color: #f97316; }
        .progress-bar { transition: width 1s linear; }
        
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
            appearance: none;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .card-pop:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ğŸš¨ ì‚¬ìš©ì Firebase ì„¤ì • ìœ ì§€ ğŸš¨
        const firebaseConfig = {
            apiKey: "AIzaSyDvtMrhYYEqpJEjwhBzEiyKgBhmcoLKROM",
            authDomain: "spyfall-b107.firebaseapp.com",
            databaseURL: "https://spyfall-b107-default-rtdb.firebaseio.com",
            projectId: "spyfall-b107",
            storageBucket: "spyfall-b107.firebasestorage.app",
            messagingSenderId: "35799604494",
            appId: "1:35799604494:web:9558db68aa6c5347d60b5f",
            measurementId: "G-HYQR22H174"
        };

        let isFirebaseConfigured = false;
        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            isFirebaseConfigured = true;
        }
        
        const database = isFirebaseConfigured ? firebase.database() : null;

        const GAME_DATA = {
            hospital: { place: "ğŸ¥ ì¢…í•©ë³‘ì›", roles: ["ì™¸ê³¼ ì˜ì‚¬", "ìˆ˜ê°„í˜¸ì‚¬", "ì‘ê¸‰ í™˜ì", "ë³‘ì›ì¥", "êµ¬ê¸‰ëŒ€ì›", "ì•½ì‚¬", "ì²­ì†Œë¶€", "ë³´í˜¸ì"] },
            school: { place: "ğŸ« ê³ ë“±í•™êµ", roles: ["ë‹´ì„ ì„ ìƒë‹˜", "ì „êµ íšŒì¥", "ì²´ìœ¡ ì„ ìƒë‹˜", "êµì¥ ì„ ìƒë‹˜", "ë§¤ì  ì´ëª¨", "ì ìëŠ” í•™ìƒ", "ì „í•™ìƒ", "ì–‘í˜¸ ì„ ìƒë‹˜"] },
            airplane: { place: "âœˆï¸ ë¹„í–‰ê¸°", roles: ["ê¸°ì¥", "ìŠ¹ë¬´ì›", "ì¼ë“±ì„ ìŠ¹ê°", "ìš°ëŠ” ì•„ê¸°", "ê¸°ë‚´ì‹ ìš”ë¦¬ì‚¬", "í•­ê³µ ë³´ì•ˆê´€", "ì •ë¹„ì‚¬", "ë¶€ê¸°ì¥"] },
            pirate: { place: "ğŸ´â€â˜ ï¸ í•´ì ì„ ", roles: ["í•´ì  ì„ ì¥", "ìš©ê°í•œ ì„ ì›", "í¬ë¡œ", "ìš”ë¦¬ì‚¬", "ì¡°íƒ€ìˆ˜", "ê°‘íŒì¥", "ì•µë¬´ìƒˆ", "ë§ì›ê²½ ë³´ëŠ” ì„ ì›"] },
            movie: { place: "ğŸ¬ ì˜í™” ì´¬ì˜ì¥", roles: ["ì˜í™” ê°ë…", "ì£¼ì—° ë°°ìš°", "ìŠ¤í„´íŠ¸ë§¨", "ì¹´ë©”ë¼ ê°ë…", "ë¶„ì¥ì‚¬", "ì—‘ìŠ¤íŠ¸ë¼", "ì‘ê°€", "ì¡°ëª… ê°ë…"] },
            casino: { place: "ğŸ° ì¹´ì§€ë…¸", roles: ["ë”œëŸ¬", "ë¶€ì ì†ë‹˜", "ë³´ì•ˆ ìš”ì›", "ë§¤ë‹ˆì €", "ëˆ ìƒì€ ì†ë‹˜", "ë°”í…ë”", "íƒ€ì§œ", "ì²­ì†Œë¶€"] },
            space: { place: "ğŸš€ ìš°ì£¼ ì •ê±°ì¥", roles: ["ìš°ì£¼ ë¹„í–‰ì‚¬", "í•¨ì¥", "ì™¸ê³„ì¸ ì—°êµ¬ì›", "ì—”ì§€ë‹ˆì–´", "ìš°ì£¼ ê´€ê´‘ê°", "AI ë¡œë´‡", "ì˜ë¬´ê´€", "í†µì‹  ì¥êµ"] },
            army: { place: "â›º êµ°ë¶€ëŒ€", roles: ["ì§€íœ˜ê´€", "ì‹ ë³‘", "ì·¨ì‚¬ë³‘", "ì¡°êµ", "ì˜ë¬´ë³‘", "íƒˆì˜ë³‘", "í–‰ë³´ê´€", "ì‚¬ê²© êµê´€"] },
            opera: { place: "ğŸ­ ì˜¤í˜ë¼ í•˜ìš°ìŠ¤", roles: ["ì˜¤í˜ë¼ ê°€ìˆ˜", "ì§€íœ˜ì", "ì—°ì£¼ì", "VIP ê´€ê°", "ë¬´ëŒ€ ê°ë…", "ì•ˆë‚´ì›", "ë§¤í‘œì†Œ ì§ì›", "ì¡°ëª… ê¸°ì‚¬"] },
            camping: { place: "â›º ìº í•‘ì¥", roles: ["ê³ ê¸° êµ½ëŠ” ì•„ë¹ ", "ë›°ì–´ë…¸ëŠ” ì•„ì´", "ìº í•‘ì¥ ì£¼ì¸", "ìˆ  ì·¨í•œ ëŒ€í•™ìƒ", "ê¸°íƒ€ ì¹˜ëŠ” ì‚¬ëŒ", "ëª¨ê¸° ë¬¼ë¦° ì‚¬ëŒ", "ì¥ì‘ íŒŒëŠ” ì‚¬ëŒ", "ì˜† í…íŠ¸ ì»¤í”Œ"] },
            cruise: { place: "ğŸš¢ í¬ë£¨ì¦ˆ ìœ ëŒì„ ", roles: ["ì„ ì¥", "ë°”í…ë”", "ë§ˆìˆ ì‚¬", "ì‹ í˜¼ë¶€ë¶€", "ê°‘ë¶€ ë…¸ì¸", "ìˆ˜ì˜ì¥ ì•ˆì „ìš”ì›", "ì¹´ì§€ë…¸ ë”œëŸ¬", "ê°ì‹¤ ì²­ì†Œë¶€"] },
            bank: { place: "ğŸ¦ ì€í–‰", roles: ["ì€í–‰ ê°•ë„", "ì§€ì ì¥", "ì°½êµ¬ ì§ì›", "ëŒ€ì¶œ ìƒë‹´ ë°›ìœ¼ëŸ¬ ì˜¨ ì‚¬ëŒ", "ì²­ì› ê²½ì°°", "ATM ìˆ˜ë¦¬ê¸°ì‚¬", "í˜„ê¸ˆ ìˆ˜ì†¡ ìš”ì›", "VIP ê³ ê°"] }
        };

        const generateRoomCode = () => Math.random().toString(36).substring(2, 6).toUpperCase();
        const generateUserId = () => 'user_' + Math.random().toString(36).substring(2, 15);
        const getRandomLocation = () => {
            const keys = Object.keys(GAME_DATA);
            return GAME_DATA[keys[Math.floor(Math.random() * keys.length)]];
        };

        const getUserColor = (uid) => {
            if (!uid) return '#9ca3af';
            const colors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e'];
            let hash = 0;
            for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        const PlayerLog = ({ players, messages }) => {
            return (
                <div className="flex flex-col h-full bg-black/40 rounded-2xl border border-white/10 overflow-hidden shadow-inner">
                    <div className="bg-white/5 p-3 px-4 border-b border-white/10 text-xs font-bold text-gray-400 uppercase flex items-center gap-2 shrink-0">
                        <i data-lucide="list" className="w-4 h-4"></i> ë‹µë³€ ê¸°ë¡
                    </div>
                    <div className="flex-1 overflow-y-auto p-3 chat-scroll space-y-3">
                        {players.map(p => {
                            const pMsgs = messages.filter(m => m.uid === p.uid && m.type === 'answer');
                            return (
                                <div key={p.uid} className="bg-white/5 rounded-xl p-3 border border-white/5">
                                    <div className="text-xs font-bold mb-2 flex items-center gap-2" style={{color: getUserColor(p.uid)}}>
                                        {p.name} <span className="text-gray-500 text-[10px]">({pMsgs.length})</span>
                                    </div>
                                    {pMsgs.length === 0 ? (
                                        <div className="text-white/20 text-[10px] pl-1">- ë‹µë³€ ì—†ìŒ -</div>
                                    ) : (
                                        <ul className="space-y-1.5">
                                            {pMsgs.map((m, i) => (
                                                <li key={i} className="text-xs text-gray-300 bg-black/20 p-2 rounded-lg leading-relaxed border-l-2 border-orange-500 pl-3">
                                                    {m.text}
                                                </li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        const ChatArea = ({ messages, chatInput, setChatInput, sendMessage, myNickname, placeholderText }) => {
            const chatEndRef = useRef(null);
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            return (
                <div className="flex flex-col h-full bg-black/40 rounded-2xl border border-white/10 overflow-hidden shadow-inner relative">
                    <div className="bg-white/5 p-3 px-4 border-b border-white/10 text-xs font-bold text-gray-400 uppercase flex items-center gap-2 shrink-0">
                        <i data-lucide="message-square" className="w-4 h-4"></i> ì‹¤ì‹œê°„ ëŒ€í™”
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 chat-scroll pb-16">
                        {messages.length === 0 && <div className="text-white/30 text-center text-sm py-10">ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        {messages.map((msg, i) => {
                            if (msg.type === 'system') return <div key={i} className="flex justify-center my-2"><span className="text-[10px] text-white/40 bg-white/5 px-3 py-1 rounded-full border border-white/5">{msg.text}</span></div>;

                            const isMe = msg.sender === myNickname;
                            const nameColor = getUserColor(msg.uid);
                            let bubbleClass = 'bg-white/5 text-gray-300 border-white/5';
                            if (msg.type === 'question') bubbleClass = 'bg-blue-900/50 text-blue-100 border-blue-500/30';
                            if (msg.type === 'answer') bubbleClass = 'bg-orange-900/50 text-orange-100 border-orange-500/30';
                            
                            return (
                                <div key={i} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-[11px] font-bold px-1" style={{ color: nameColor }}>{msg.sender}</span>
                                        {msg.type === 'question' && <span className="text-[9px] bg-blue-500/20 text-blue-300 px-1.5 py-0.5 rounded border border-blue-500/30">â“ì§ˆë¬¸</span>}
                                        {msg.type === 'answer' && <span className="text-[9px] bg-orange-500/20 text-orange-300 px-1.5 py-0.5 rounded border border-orange-500/30">ğŸ’¬ë‹µë³€</span>}
                                    </div>
                                    <div className={`px-4 py-2.5 rounded-2xl text-sm max-w-[90%] break-words shadow-sm leading-relaxed border ${bubbleClass} ${isMe ? 'rounded-tr-none' : 'rounded-tl-none'}`}>
                                        {msg.text}
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={chatEndRef} />
                    </div>
                    <form onSubmit={sendMessage} className="absolute bottom-0 left-0 right-0 p-2 bg-black/60 backdrop-blur-sm border-t border-white/10 flex gap-2">
                        <input value={chatInput} onChange={e => setChatInput(e.target.value)} 
                            className="flex-1 bg-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:bg-white/10 transition-all placeholder-gray-500"
                            placeholder={placeholderText} 
                        />
                        <button type="submit" className="bg-blue-600 hover:bg-blue-500 p-3 rounded-xl transition-colors shadow-lg" disabled={!chatInput.trim()}>
                            <i data-lucide="send" className="w-5 h-5 text-white"></i>
                        </button>
                    </form>
                </div>
            );
        };

        const TimerBar = ({ startTime, duration, onExpire, label, colorClass, showControl, onReduce }) => {
            const [timeLeft, setTimeLeft] = useState(duration);
            const [progress, setProgress] = useState(100);

            useEffect(() => {
                const interval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const remaining = Math.max(0, duration - elapsed);
                    setTimeLeft(remaining);
                    setProgress((remaining / duration) * 100);

                    if (remaining <= 0) {
                        clearInterval(interval);
                        if (onExpire) onExpire();
                    }
                }, 100);
                return () => clearInterval(interval);
            }, [startTime, duration]);

            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);

            return (
                <div className="w-full mb-3">
                    <div className="flex justify-between items-center text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider">
                        <span className="flex items-center gap-2">
                            {label}
                            {/* [ê¸°ëŠ¥] ì‹œê°„ ì¡°ì ˆ ê¸°ëŠ¥ ì¶”ê°€ */}
                            {showControl && <button onClick={onReduce} className="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-1.5 py-0.5 rounded border border-red-500/30 transition-colors">-1ë¶„</button>}
                        </span>
                        <span className={timeLeft < 5000 ? "text-red-500 animate-ping font-black" : "text-white"}>
                            {minutes}:{seconds.toString().padStart(2, '0')}
                        </span>
                    </div>
                    <div className="h-2 w-full bg-gray-700/50 rounded-full overflow-hidden">
                        <div className={`h-full progress-bar ${colorClass}`} style={{ width: `${progress}%` }}></div>
                    </div>
                </div>
            );
        };

        // --- ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€ ---

        // [ê¸°ëŠ¥] ì¥ì†Œ ì¡±ë³´ ëª¨ë‹¬
        const LocationModal = ({ onClose }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4 modal-enter" onClick={onClose}>
                <div className="glass-card w-full max-w-2xl max-h-[85vh] overflow-y-auto rounded-2xl p-6" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-black text-yellow-400">ğŸ—ºï¸ ì¥ì†Œ ì¡±ë³´</h2>
                        <button onClick={onClose} className="bg-white/10 p-2 rounded-full"><i data-lucide="x" className="w-5 h-5"></i></button>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                        {Object.values(GAME_DATA).map((loc, i) => (
                            <div key={i} className="bg-white/5 p-4 rounded-xl border border-white/5 hover:bg-white/10 transition-colors">
                                <div className="font-bold text-lg mb-1">{loc.place}</div>
                                <div className="text-xs text-gray-400 truncate">{loc.roles.slice(0, 3).join(', ')}...</div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        // [ê¸°ëŠ¥] ì§€ëª© ê°•ì œ íŒì—…
        const PlayerSelectionModal = ({ players, onSelect }) => (
            <div className="fixed inset-0 z-[70] flex flex-col items-center justify-center bg-black/95 p-6 modal-enter">
                <h2 className="text-3xl font-black text-blue-400 mb-2 text-center animate-bounce">ğŸ‘‰ ëˆ„êµ¬ì—ê²Œ ì§ˆë¬¸í• ê¹Œìš”?</h2>
                <p className="text-gray-400 mb-8 text-center">ë°˜ë“œì‹œ í•œ ëª…ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.</p>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 w-full max-w-3xl">
                    {players.map(p => (
                        <button key={p.uid} onClick={() => onSelect(p.uid)} 
                            className="bg-gray-800 border-2 border-gray-600 hover:border-blue-500 hover:bg-gray-700 p-6 rounded-2xl flex flex-col items-center gap-3 transition-all transform hover:scale-105 card-pop group">
                            <div className="w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold bg-gray-900 group-hover:bg-blue-600 transition-colors" style={{color: getUserColor(p.uid)}}>
                                {p.name.substring(0,1)}
                            </div>
                            <span className="text-xl font-bold text-white">{p.name}</span>
                        </button>
                    ))}
                </div>
            </div>
        );

        // [ê¸°ëŠ¥] íˆ¬í‘œ ëª¨ë‹¬
        const VoteModal = ({ players, votes, myVote, onVote, onClose }) => {
            const voteCounts = {};
            Object.values(votes || {}).forEach(targetId => {
                voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
            });

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-red-900/90 p-4 modal-enter">
                    <div className="glass-card w-full max-w-md rounded-2xl p-6 border-red-500/30">
                        <h2 className="text-2xl font-black text-red-400 mb-2 text-center">ğŸš¨ ìŠ¤íŒŒì´ ì§€ëª© íˆ¬í‘œ</h2>
                        <p className="text-center text-xs text-red-200 mb-6">ê³¼ë°˜ìˆ˜ ì´ìƒ ë“í‘œìê°€ ë‚˜ì˜¤ë©´ ê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</p>
                        
                        <div className="space-y-2 mb-6">
                            {players.map(p => {
                                const count = voteCounts[p.uid] || 0;
                                const isSelected = myVote === p.uid;
                                return (
                                    <button key={p.uid} onClick={() => onVote(p.uid)} disabled={myVote === p.uid}
                                        className={`w-full flex justify-between items-center p-4 rounded-xl border transition-all ${isSelected ? 'bg-red-600 border-red-400' : 'bg-black/40 border-white/5 hover:bg-white/5'}`}>
                                        <span className="font-bold">{p.name}</span>
                                        <div className="flex items-center gap-2">
                                            {count > 0 && <span className="text-xs bg-white/20 px-2 py-1 rounded">{count}í‘œ</span>}
                                            {isSelected && <i data-lucide="check-circle" className="w-5 h-5"></i>}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                        <button onClick={onClose} className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">ë‹«ê¸°</button>
                    </div>
                </div>
            );
        };

        // ì—ëŸ¬ ê²½ê³„
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { 
                this.setState({ error, errorInfo });
                console.error("Crash detected:", error, errorInfo); 
            }
            handleReset = () => {
                if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œê³ ì¹¨ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="spy-bg flex items-center justify-center text-center p-6">
                            <div className="glass-card p-8 rounded-3xl w-full max-w-md">
                                <h1 className="text-3xl font-black mb-4 text-red-500">ğŸš« ì˜¤ë¥˜ ë°œìƒ!</h1>
                                <p className="text-gray-300 mb-4 font-bold text-lg">ì•±ì´ ì˜ˆê¸°ì¹˜ ì•Šê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                                <div className="bg-black/50 p-4 rounded-xl text-left text-xs font-mono text-red-300 mb-6 overflow-auto max-h-40">
                                    {this.state.error && this.state.error.toString()}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => window.location.reload()} className="flex-1 bg-white/10 px-6 py-3 rounded-xl font-bold hover:bg-white/20">ìƒˆë¡œê³ ì¹¨</button>
                                    <button onClick={this.handleReset} className="flex-1 bg-red-600/80 px-6 py-3 rounded-xl font-bold hover:bg-red-600">ë°ì´í„° ì´ˆê¸°í™”</button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const ConnectionStatus = () => {
            const [connected, setConnected] = useState(false);
            useEffect(() => {
                if (!database) return;
                const connectedRef = database.ref('.info/connected');
                const listener = connectedRef.on('value', (snap) => setConnected(snap.val() === true));
                return () => connectedRef.off('value', listener);
            }, []);
            if (!isFirebaseConfigured) return null;
            return (
                <div className={`fixed top-4 left-4 px-3 py-1.5 rounded-full text-xs font-bold border flex items-center gap-2 z-50 transition-colors ${connected ? 'bg-green-500/20 text-green-400 border-green-500/30' : 'bg-red-500/20 text-red-400 border-red-500/30'}`}>
                    <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`}></div>
                    {connected ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸'}
                </div>
            );
        };

        function App() {
            let statusText = "ê²Œì„ ëŒ€ê¸° ì¤‘ ...";
            const [userId] = useState(() => {
                const stored = localStorage.getItem('spyfall_user_id');
                if (stored) return stored;
                const newId = generateUserId();
                localStorage.setItem('spyfall_user_id', newId);
                return newId;
            });

            const [view, setView] = useState('lobby'); 
            const [roomId, setRoomId] = useState(''); 
            const [inputRoomId, setInputRoomId] = useState(''); 
            
            const [nickname, setNickname] = useState(localStorage.getItem('spyfall_nickname') || '');
            const [roomData, setRoomData] = useState(null);
            const [error, setError] = useState('');
            const [messages, setMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            
            const [showRoleModal, setShowRoleModal] = useState(false);
            const [showResultModal, setShowResultModal] = useState(false);
            const [turnNotification, setTurnNotification] = useState(null);
            
            // [ê¸°ëŠ¥] ìƒˆë¡œìš´ ëª¨ë‹¬ ìƒíƒœ
            const [showLocationModal, setShowLocationModal] = useState(false);
            const [showVoteModal, setShowVoteModal] = useState(false);

            const [gameTimeOpt, setGameTimeOpt] = useState(8);
            const [turnTimeOpt, setTurnTimeOpt] = useState(40); // ê¸°ë³¸ê°’ ì‚´ì§ ëŠ˜ë¦¼

            const lastTurnTimeRef = useRef(0);

            useEffect(() => { if (nickname) localStorage.setItem('spyfall_nickname', nickname); }, [nickname]);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [view, showRoleModal, showResultModal, showLocationModal, showVoteModal, roomData, turnNotification]);

            // [ê¸°ëŠ¥] ì„¤ì • ë³€ê²½ ë™ê¸°í™”
            useEffect(() => {
                if (roomData?.settings) {
                    setGameTimeOpt(roomData.settings.gameDuration / 60000);
                    setTurnTimeOpt(roomData.settings.turnDuration / 1000);
                }
            }, [roomData?.settings]);

            // [ê¸°ëŠ¥] íˆ¬í‘œ ê²°ê³¼ ì²´í¬
            useEffect(() => {
                if (roomData?.votes && roomData?.status === 'playing') {
                    const players = Object.keys(roomData.players);
                    const votes = Object.values(roomData.votes);
                    const voteCounts = {};
                    votes.forEach(v => voteCounts[v] = (voteCounts[v] || 0) + 1);
                    
                    const majority = Math.floor(players.length / 2) + 1;
                    const elected = Object.keys(voteCounts).find(uid => voteCounts[uid] >= majority);

                    if (elected) {
                        handleEndGame(`íˆ¬í‘œ ê²°ê³¼, ${roomData.players[elected].name}ë‹˜ì´ ì²´í¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    }
                }
            }, [roomData?.votes]);

            useEffect(() => {
                if (roomData?.status === 'playing') {
                    if (!showRoleModal && view !== 'game') setShowRoleModal(true);
                    setShowResultModal(false);
                } else if (roomData?.status === 'finished') {
                    setShowResultModal(true);
                    setShowRoleModal(false);
                    setTurnNotification(null);
                    setShowVoteModal(false);
                } else if (roomData?.status === 'waiting') {
                    setShowResultModal(false);
                    setShowRoleModal(false);
                    setTurnNotification(null);
                }
            }, [roomData?.status]);

            useEffect(() => {
                if (roomData?.status === 'playing' && roomData.gameState) {
                    const { turnStartTime, turnPlayer, targetPlayer } = roomData.gameState;
                    if (turnStartTime > lastTurnTimeRef.current) {
                        lastTurnTimeRef.current = turnStartTime;
                        if (turnPlayer === userId && !targetPlayer) {
                            setTurnNotification({ type: 'ask', title: 'ğŸ—£ï¸ ì§ˆë¬¸ ì°¨ë¡€!', message: 'ì›í•˜ëŠ” ì‚¬ëŒì„ ì§€ëª©í•˜ê³  ì§ˆë¬¸í•˜ì„¸ìš”.', color: 'bg-blue-600 border-blue-400' });
                        } else if (targetPlayer === userId) {
                            setTurnNotification({ type: 'answer', title: 'ğŸ’¬ ë‹µë³€ ì°¨ë¡€!', message: 'ì§ˆë¬¸ì— ëŒ€ë‹µí•˜ê³  í„´ì„ ë„˜ê¸°ì„¸ìš”.', color: 'bg-orange-600 border-orange-400' });
                        }
                    }
                }
            }, [roomData, userId]);

            useEffect(() => {
                if (!roomId || !database) return;
                const roomRef = database.ref('rooms/' + roomId);
                const chatRef = database.ref('rooms/' + roomId + '/messages');
                const myPlayerRef = database.ref('rooms/' + roomId + '/players/' + userId);

                const roomListener = roomRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setRoomData(data);
                        localStorage.setItem('spyfall_current_room', roomId);
                    } else {
                        alert('ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        leaveRoomCleanup();
                    }
                });

                const chatListener = chatRef.limitToLast(100).on('value', (snapshot) => {
                    const data = snapshot.val();
                    setMessages(data ? Object.values(data) : []);
                });

                myPlayerRef.onDisconnect().remove();

                return () => {
                    roomRef.off('value', roomListener);
                    chatRef.off('value', chatListener);
                    myPlayerRef.onDisconnect().cancel();
                };
            }, [roomId]);

            const leaveRoomCleanup = async () => {
                if (roomId && database) {
                    try {
                        await database.ref(`rooms/${roomId}/messages`).push({
                            sender: 'System', text: `${nickname}ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`, timestamp: Date.now(), type: 'system'
                        });
                    } catch(e) {}
                    await database.ref('rooms/' + roomId + '/players/' + userId).remove();
                    localStorage.removeItem('spyfall_current_room');
                    setRoomId(''); setRoomData(null); setMessages([]); setView('lobby');
                }
            };

            // [ê¸°ëŠ¥] ì„¤ì • ë³€ê²½
            const handleUpdateSettings = async (type, value) => {
                if (!roomId || roomData.hostId !== userId) return;
                const updates = {};
                if (type === 'game') updates['settings/gameDuration'] = value * 60 * 1000;
                if (type === 'turn') updates['settings/turnDuration'] = value * 1000;
                await database.ref(`rooms/${roomId}`).update(updates);
            };

            const handleCreateRoom = async () => {
                if (!isFirebaseConfigured) return alert("Firebase í‚¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!");
                if (!nickname.trim()) return setError('ë‹‰ë„¤ì„ í•„ìˆ˜');
                const newId = generateRoomCode();
                try {
                    await database.ref('rooms/' + newId).set({
                        hostId: userId,
                        players: { [userId]: { uid: userId, name: nickname, role: null, isSpy: false } },
                        status: 'waiting',
                        createdAt: Date.now(),
                        settings: { gameDuration: gameTimeOpt * 60 * 1000, turnDuration: turnTimeOpt * 1000 },
                        votes: {}
                    });
                    await database.ref(`rooms/${newId}/messages`).push({ sender: 'System', text: `${nickname}ë‹˜ì´ ë°©ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.`, timestamp: Date.now(), type: 'system' });
                    setRoomId(newId); setInputRoomId(newId); setView('room');
                } catch (e) { alert("ë°© ìƒì„± ì‹¤íŒ¨!"); console.error(e); }
            };

            const handleJoinRoom = async () => {
                if (!isFirebaseConfigured) return alert("Firebase í‚¤ ì„¤ì • í•„ìš”");
                if (!nickname.trim() || !inputRoomId.trim()) return setError('ì •ë³´ ì…ë ¥ í•„ìˆ˜');
                const targetId = inputRoomId.toUpperCase();
                try {
                    const snap = await database.ref('rooms/' + targetId).once('value');
                    const data = snap.val();
                    if (!data) return setError('ì—†ëŠ” ë°©ì…ë‹ˆë‹¤.');
                    if (data.status === 'playing') return setError('ì´ë¯¸ ì‹œì‘ë¨');
                    await database.ref(`rooms/${targetId}/players/${userId}`).set({ uid: userId, name: nickname, role: null, isSpy: false });
                    await database.ref(`rooms/${targetId}/messages`).push({ sender: 'System', text: `${nickname}ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`, timestamp: Date.now(), type: 'system' });
                    setRoomId(targetId); setView('room');
                } catch (e) { alert("ì ‘ì† ì‹¤íŒ¨!"); }
            };

            const handleStartGame = async () => {
                const players = Object.values(roomData.players || {});
                if (players.length < 3) return alert('ìµœì†Œ 3ëª… í•„ìš”');
                const location = getRandomLocation();
                let roles = [...location.roles].sort(() => Math.random() - 0.5);
                const spyIndex = Math.floor(Math.random() * players.length);
                const updatedPlayers = {};
                const firstPlayerId = players[Math.floor(Math.random() * players.length)].uid;
                players.forEach((p, idx) => {
                    updatedPlayers[p.uid] = { ...p, role: idx === spyIndex ? 'SPY' : roles.pop() || 'ì‹œë¯¼', isSpy: idx === spyIndex };
                });
                await database.ref('rooms/' + roomId).update({
                    status: 'playing', locationName: location.place, players: updatedPlayers, messages: null, votes: {},
                    gameState: { gameStartTime: Date.now(), turnStartTime: Date.now(), turnPlayer: firstPlayerId, targetPlayer: null }
                });
                await database.ref(`rooms/${roomId}/messages`).push({ sender: 'System', text: `ê²Œì„ ì‹œì‘! (${roomData.settings?.gameDuration/60000}ë¶„)`, timestamp: Date.now(), type: 'system' });
                lastTurnTimeRef.current = 0; 
            };

            const handleEndGame = async (reason = "") => { 
                await database.ref('rooms/' + roomId).update({ status: 'finished', endReason: reason }); 
            };

            const handleRestart = async () => {
                const players = Object.values(roomData.players || {});
                const resetPlayers = {};
                players.forEach(p => resetPlayers[p.uid] = { ...p, role: null, isSpy: false });
                await database.ref('rooms/' + roomId + '/messages').remove();
                await database.ref('rooms/' + roomId).update({ status: 'waiting', locationName: null, players: resetPlayers, gameState: null, votes: {} });
            };

            const handleSelectPlayer = async (targetId) => {
                if (!roomData?.gameState) return;
                await database.ref(`rooms/${roomId}/gameState`).update({ targetPlayer: targetId, turnStartTime: Date.now() });
            };

            // [ê¸°ëŠ¥] íˆ¬í‘œ ë¡œì§
            const handleVote = async (targetUid) => {
                await database.ref(`rooms/${roomId}/votes/${userId}`).set(targetUid);
            };

            // [ê¸°ëŠ¥] ì‹œê°„ ì¤„ì´ê¸°
            const handleReduceGameTime = async () => {
                const currentStart = roomData.gameState.gameStartTime;
                await database.ref(`rooms/${roomId}/gameState`).update({ gameStartTime: currentStart - 60000 });
                sendMessageLocal("â° ë°©ì¥ì´ ì‹œê°„ì„ 1ë¶„ ì¤„ì˜€ìŠµë‹ˆë‹¤.", "system");
            };

            // [ê¸°ëŠ¥] í„´ ìŠ¤í‚µ
            const handleSkipTurn = async () => {
                const { turnPlayer, targetPlayer } = roomData.gameState;
                const playerIds = Object.keys(roomData.players);
                // ëœë¤í•˜ê²Œ ë‹¤ìŒ ì‚¬ëŒ ë„˜ê¹€
                const candidates = playerIds.filter(id => id !== turnPlayer);
                const randomTarget = candidates[Math.floor(Math.random() * candidates.length)];
                await database.ref(`rooms/${roomId}/gameState`).update({ turnPlayer: userId, targetPlayer: randomTarget, turnStartTime: Date.now() }); // ì„ì‹œë¡œ ë‚´ í„´ ì²˜ë¦¬ í›„ ë„˜ê¹€ ë°©ì§€ ë“±ì„ ìœ„í•´ ë¡œì§ ë‹¨ìˆœí™”
                
                // ì‹¤ì œë¡œëŠ” ê·¸ëƒ¥ íƒ€ê²Ÿì„ ëœë¤ ì§€ì •í•˜ê±°ë‚˜ í„´ í”Œë ˆì´ì–´ë¥¼ ë°”ê¿ˆ
                if (!targetPlayer) {
                   await database.ref(`rooms/${roomId}/gameState`).update({ targetPlayer: randomTarget, turnStartTime: Date.now() });
                } else {
                   await database.ref(`rooms/${roomId}/gameState`).update({ turnPlayer: targetPlayer, targetPlayer: null, turnStartTime: Date.now() });
                }
                sendMessageLocal("â© ë°©ì¥ì´ í„´ì„ ìŠ¤í‚µí–ˆìŠµë‹ˆë‹¤.", "system");
            };

            const handleGameTimeExpire = () => { if (roomData.hostId === userId) handleEndGame(); };

            const handleTurnTimeExpire = () => {
                if (roomData.hostId !== userId || !roomData.gameState) return;
                const { turnPlayer, targetPlayer } = roomData.gameState;
                const playerIds = Object.keys(roomData.players);
                if (!targetPlayer) {
                    const candidates = playerIds.filter(id => id !== turnPlayer);
                    if (candidates.length > 0) {
                        const randomTarget = candidates[Math.floor(Math.random() * candidates.length)];
                        database.ref(`rooms/${roomId}/gameState`).update({ targetPlayer: randomTarget, turnStartTime: Date.now() });
                    }
                } else {
                    database.ref(`rooms/${roomId}/gameState`).update({ turnPlayer: targetPlayer, targetPlayer: null, turnStartTime: Date.now() });
                }
            };

            const sendMessageLocal = (text, type='chat') => {
                 database.ref(`rooms/${roomId}/messages`).push({ sender: nickname, uid: userId, text, timestamp: Date.now(), type });
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                let msgType = 'chat';
                if (roomData?.status === 'playing' && roomData.gameState) {
                    if (roomData.gameState.turnPlayer === userId && !roomData.gameState.targetPlayer) msgType = 'question';
                    else if (roomData.gameState.targetPlayer === userId) msgType = 'answer';
                }
                await database.ref(`rooms/${roomId}/messages`).push({ sender: nickname, uid: userId, text: chatInput, timestamp: Date.now(), type: msgType });
                setChatInput('');
                if (msgType === 'answer') {
                    // ë‹µë³€ í›„ ìë™ í„´ ë„˜ê¹€
                    await database.ref(`rooms/${roomId}/gameState`).update({ turnPlayer: userId, targetPlayer: null, turnStartTime: Date.now() });
                }
            };

            const copyCode = () => { navigator.clipboard ? navigator.clipboard.writeText(roomId).then(() => alert('ì½”ë“œ ë³µì‚¬ë¨')) : prompt("ë°© ì½”ë“œ", roomId); };

            // --- UI ---

            if (!isFirebaseConfigured) return <div className="spy-bg flex items-center justify-center p-6 text-center text-white font-bold">âš ï¸ ì„¤ì • í•„ìš”: API KEYë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>;

            if (view === 'lobby') {
                return (
                    <div className="spy-bg flex items-center justify-center p-4">
                        <ConnectionStatus />
                        <div className="w-full max-w-sm glass-card p-6 rounded-3xl text-center shadow-2xl relative z-10">
                            <div className="mb-6"><div className="text-5xl mb-2 drop-shadow-lg animate-bounce">ğŸ•µï¸</div><h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-amber-500 tracking-tighter">SPYFALL</h1><p className="text-xs text-white/30 font-mono mt-2">Ver 5.6 Safe Connect</p></div>
                            <div className="space-y-3">
                                <div><label className="text-xs text-gray-400 font-bold block text-left ml-2 mb-1">ë‹‰ë„¤ì„</label><input value={nickname} onChange={e => setNickname(e.target.value)} placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white text-lg focus:outline-none focus:ring-2 focus:ring-red-500/50 transition-all placeholder-gray-600" /></div>
                                <div className="bg-white/5 rounded-xl p-3 text-left space-y-2 border border-white/5">
                                    <div className="flex justify-between items-center"><label className="text-xs text-gray-400 font-bold flex items-center gap-1"><i data-lucide="clock" className="w-3 h-3"></i> ì „ì²´ ê²Œì„</label><select value={gameTimeOpt} onChange={e => setGameTimeOpt(Number(e.target.value))} className="bg-black/40 text-white text-xs rounded px-2 py-1 outline-none border border-white/10 w-20"><option value={5}>5ë¶„</option><option value={8}>8ë¶„</option><option value={10}>10ë¶„</option><option value={15}>15ë¶„</option><option value={20}>20ë¶„</option></select></div>
                                    <div className="flex justify-between items-center"><label className="text-xs text-gray-400 font-bold flex items-center gap-1"><i data-lucide="hourglass" className="w-3 h-3"></i> í„´ ì‹œê°„</label><select value={turnTimeOpt} onChange={e => setTurnTimeOpt(Number(e.target.value))} className="bg-black/40 text-white text-xs rounded px-2 py-1 outline-none border border-white/10 w-20"><option value={20}>20ì´ˆ</option><option value={30}>30ì´ˆ</option><option value={40}>40ì´ˆ</option><option value={60}>60ì´ˆ</option><option value={90}>90ì´ˆ</option></select></div>
                                </div>
                                {error && <div className="text-red-400 text-xs font-bold bg-red-500/10 py-2 rounded-lg animate-pulse">{error}</div>}
                                <div className="pt-2 space-y-3">
                                    <button onClick={handleCreateRoom} className="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-900/20 active:scale-95 transition-all flex items-center justify-center gap-2"><i data-lucide="plus" className="w-5 h-5"></i> ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°</button>
                                    <div className="relative flex items-center py-1"><div className="flex-grow border-t border-white/10"></div><span className="flex-shrink-0 mx-2 text-gray-500 text-xs">OR</span><div className="flex-grow border-t border-white/10"></div></div>
                                    <div className="flex gap-2 h-20"><input value={inputRoomId} onChange={e => setInputRoomId(e.target.value.toUpperCase())} placeholder="A1B2" maxLength={4} className="w-24 bg-black/40 border border-white/10 rounded-xl px-2 text-center uppercase text-white font-black text-xl focus:outline-none focus:border-blue-500 transition-all placeholder-gray-700" /><button onClick={handleJoinRoom} className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-xl font-black text-3xl shadow-lg shadow-blue-900/30 active:scale-95 transition-all flex items-center justify-center gap-2"><i data-lucide="log-in" className="w-8 h-8"></i> ì°¸ê°€</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'room' || view === 'game' || view === 'result') {
                if (!roomData) {
                    setTimeout(() => { const el = document.getElementById('loading-msg'); if(el) el.innerText = "ì—°ê²°ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤... (ìƒˆë¡œê³ ì¹¨ ê¶Œì¥)"; }, 5000);
                    return <div className="spy-bg flex items-center justify-center flex-col"><div className="spinner mb-4"></div><div id="loading-msg" className="text-white font-bold animate-pulse">ë°ì´í„° ë¡œë”© ì¤‘...</div></div>;
                }
                
                const players = Object.values(roomData.players || {});
                const isHost = roomData.hostId === userId;
                const me = roomData.players ? roomData.players[userId] : null;
                const gameState = roomData.gameState;
                const gameDuration = roomData.settings?.gameDuration || 8 * 60 * 1000;
                const turnDuration = roomData.settings?.turnDuration || 20 * 1000;

                if (!me) return <div className="spy-bg flex items-center justify-center flex-col p-4 text-center text-white"><h2 className="text-xl font-bold mb-4">ì—°ê²° ëŠê¹€</h2><button onClick={leaveRoomCleanup} className="bg-white/20 px-6 py-3 rounded-xl">ë‚˜ê°€ê¸°</button></div>;

                const isPlaying = roomData.status === 'playing';
                const isMyTurn = gameState?.turnPlayer === userId;
                const isMyTargetTurn = gameState?.targetPlayer === userId;
                const isMyTurnToAsk = isPlaying && isMyTurn && !gameState.targetPlayer;
                
                let chatPlaceholder = "ë©”ì‹œì§€ ì…ë ¥...";
                if (isPlaying && gameState) {
                    if (!gameState.targetPlayer) {
                        const tp = roomData.players[gameState.turnPlayer];
                        statusText = `ğŸ—£ï¸ ${tp?.name || '???'}ë‹˜ì´ ì§ˆë¬¸í•˜ëŠ” ì¤‘...`;
                        chatPlaceholder = !isMyTurn ? "ì§ˆë¬¸ìê°€ ë°œì–¸ ì¤‘ì…ë‹ˆë‹¤" : (messages.some(m => m.uid === userId && m.type === 'question' && m.timestamp > gameState.turnStartTime) ? "ğŸ‘‰ ì§ˆë¬¸ ì™„ë£Œ! ëŒ€ìƒì„ ì§€ëª©í•˜ì„¸ìš”!" : "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”");
                    } else {
                        const tp = roomData.players[gameState.targetPlayer];
                        statusText = `ğŸ’¬ ${tp?.name || '???'}ë‹˜ì´ ë‹µë³€í•˜ëŠ” ì¤‘...`;
                        chatPlaceholder = !isMyTargetTurn ? "ë‹µë³€ìê°€ ë‹µë³€ ì¤‘ì…ë‹ˆë‹¤" : "ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš” (ì—”í„° ì‹œ í„´ ë„˜ê¹€)";
                    }
                }

                return (
                    <div className="spy-bg p-4 flex flex-col h-screen">
                        <ConnectionStatus />
                        <div className="max-w-5xl mx-auto w-full h-full flex flex-col relative">
                            {/* ìƒë‹¨ë°” */}
                            <div className="glass-card p-3 rounded-2xl mb-3 flex justify-between items-center shrink-0">
                                <div><span className="text-[10px] text-gray-400 font-bold block">ROOM CODE</span><span className="text-xl font-black text-yellow-400 tracking-widest">{roomId}</span></div>
                                <div className="hidden md:block text-sm font-bold text-white/80 animate-pulse">{statusText}</div>
                                <div className="flex gap-2">
                                    {/* [ê¸°ëŠ¥] ì¥ì†Œ ì¡±ë³´ ë²„íŠ¼ */}
                                    <button onClick={() => setShowLocationModal(true)} className="bg-purple-500/20 text-purple-300 border border-purple-500/30 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"><i data-lucide="map" className="w-3 h-3"></i> ì¡±ë³´</button>
                                    <button onClick={copyCode} className="bg-white/10 px-3 py-1.5 rounded-lg text-sm font-bold text-white border border-white/10">ë³µì‚¬</button>
                                    <button onClick={leaveRoomCleanup} className="bg-red-500/20 text-red-400 px-3 py-1.5 rounded-lg text-sm font-bold border border-red-500/20">ë‚˜ê°€ê¸°</button>
                                </div>
                            </div>
                            
                            {/* [ê¸°ëŠ¥] ëŒ€ê¸°ì‹¤ ì„¤ì • ë³€ê²½ */}
                            {!isPlaying && roomData.status === 'waiting' && (
                                <div className="glass-card p-4 rounded-2xl mb-3 text-center">
                                    <div className="text-gray-400 text-xs font-bold mb-3 uppercase tracking-wider">Game Settings (ë°©ì¥ ë³€ê²½ ê°€ëŠ¥)</div>
                                    <div className="flex gap-4 justify-center">
                                        <div className="flex flex-col gap-1">
                                            <label className="text-xs text-gray-500">ì „ì²´ ì‹œê°„ (ë¶„)</label>
                                            <select disabled={!isHost} value={gameTimeOpt} onChange={e => handleUpdateSettings('game', e.target.value)} className="bg-black/30 border border-white/10 rounded px-3 py-2 text-white font-bold disabled:opacity-50">
                                                <option value="5">5ë¶„</option><option value="8">8ë¶„</option><option value="10">10ë¶„</option><option value="15">15ë¶„</option>
                                            </select>
                                        </div>
                                        <div className="flex flex-col gap-1">
                                            <label className="text-xs text-gray-500">í„´ ì œí•œ (ì´ˆ)</label>
                                            <select disabled={!isHost} value={turnTimeOpt} onChange={e => handleUpdateSettings('turn', e.target.value)} className="bg-black/30 border border-white/10 rounded px-3 py-2 text-white font-bold disabled:opacity-50">
                                                <option value="20">20ì´ˆ</option><option value="30">30ì´ˆ</option><option value="40">40ì´ˆ</option><option value="60">60ì´ˆ</option><option value="90">90ì´ˆ</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* íƒ€ì´ë¨¸ */}
                            {roomData.status === 'playing' && gameState && (
                                <div className="glass-card p-3 rounded-2xl mb-3 shrink-0">
                                    <TimerBar startTime={gameState.gameStartTime} duration={gameDuration} onExpire={handleGameTimeExpire} label="ì „ì²´ ì‹œê°„" colorClass="bg-gradient-to-r from-indigo-500 to-purple-500" showControl={isHost} onReduce={handleReduceGameTime} />
                                    <div className="mt-2 pt-2 border-t border-white/10 flex items-center gap-2">
                                        <div className="flex-1"><TimerBar startTime={gameState.turnStartTime} duration={turnDuration} onExpire={handleTurnTimeExpire} label={`í„´ ì œí•œì‹œê°„ (${turnDuration/1000}ì´ˆ)`} colorClass="bg-gradient-to-r from-orange-500 to-red-500" /></div>
                                        {isHost && <button onClick={handleSkipTurn} className="bg-white/10 p-2 rounded-lg text-xs font-bold text-gray-300 whitespace-nowrap hover:bg-white/20">â© ìŠ¤í‚µ</button>}
                                    </div>
                                </div>
                            )}

                            {/* ì—­í•  íŒì—… */}
                            {showRoleModal && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-6 modal-enter" onClick={() => setShowRoleModal(false)}>
                                    <div className={`w-full max-w-sm p-8 rounded-[2rem] text-center shadow-2xl border-2 relative overflow-hidden ${me.isSpy ? 'bg-gradient-to-b from-red-900 to-black border-red-500' : 'bg-gradient-to-b from-blue-900 to-black border-blue-500'}`} onClick={e => e.stopPropagation()}>
                                        <div className="text-7xl mb-6 filter drop-shadow-lg">{me.isSpy ? 'ğŸ¤«' : 'ğŸ“'}</div><h2 className="text-3xl font-black mb-2 text-white">{me.isSpy ? 'ë‹¹ì‹ ì€ ìŠ¤íŒŒì´!' : 'ë‹¹ì‹ ì˜ ì—­í• '}</h2>{me.isSpy ? <p className="text-red-200 bg-red-950/50 p-4 rounded-xl mt-4">ì¥ì†Œë¥¼ ëª¨ë¦…ë‹ˆë‹¤.<br/>ëˆˆì¹˜ê» í–‰ë™í•˜ì„¸ìš”!</p> : <div className="mt-6 space-y-4"><div><div className="text-xs text-blue-300 uppercase">Role</div><div className="text-3xl font-bold text-white">{me.role}</div></div><div className="h-px bg-white/10 w-1/2 mx-auto"></div><div><div className="text-xs text-blue-300 uppercase">Location</div><div className="text-2xl font-bold text-yellow-400">{roomData.locationName}</div></div></div>}<button onClick={() => setShowRoleModal(false)} className="mt-8 w-full bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-white border border-white/10">ë‹«ê¸°</button>
                                    </div>
                                </div>
                            )}

                            {/* [ê¸°ëŠ¥] ì§€ëª© íŒì—… (ë‚´ í„´ì´ê³  ì§ˆë¬¸ì„ í–ˆì„ ë•Œ) */}
                            {isMyTurnToAsk && messages.some(m => m.uid === userId && m.type === 'question' && m.timestamp > gameState.turnStartTime) && (
                                <PlayerSelectionModal players={players.filter(p => p.uid !== userId)} onSelect={handleSelectPlayer} />
                            )}
                            
                            {/* [ê¸°ëŠ¥] ì¥ì†Œ ì¡±ë³´ ëª¨ë‹¬ */}
                            {showLocationModal && <LocationModal onClose={() => setShowLocationModal(false)} />}
                            
                            {/* [ê¸°ëŠ¥] íˆ¬í‘œ ëª¨ë‹¬ */}
                            {showVoteModal && (
                                <VoteModal players={players} votes={roomData.votes} myVote={(roomData.votes || {})[userId]} onVote={handleVote} onClose={() => setShowVoteModal(false)} />
                            )}

                            {/* ì—­í•  í™•ì¸ ë²„íŠ¼ + íˆ¬í‘œ ë²„íŠ¼ */}
                            {roomData.status === 'playing' && (
                                <div className="flex gap-2 mb-3 shrink-0">
                                    <button onClick={() => setShowRoleModal(true)} className="flex-1 bg-white/5 hover:bg-white/10 p-2 rounded-xl font-bold text-gray-300 text-xs flex items-center justify-center gap-2 border border-white/5 transition-colors"><i data-lucide="id-card" className="w-4 h-4"></i> ë‚´ ì—­í• </button>
                                    <button onClick={() => setShowVoteModal(true)} className="flex-1 bg-red-600/20 text-red-400 border border-red-500/30 p-2 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-red-600 hover:text-white transition-colors"><i data-lucide="alert-triangle" className="w-4 h-4"></i> ìŠ¤íŒŒì´ íˆ¬í‘œ</button>
                                </div>
                            )}

                            {/* í”Œë ˆì´ì–´ ëª©ë¡ */}
                            <div className="glass-card rounded-2xl p-3 mb-3 shrink-0">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    {players.map(p => {
                                        const isTurn = gameState?.turnPlayer === p.uid;
                                        const isTarget = gameState?.targetPlayer === p.uid;
                                        return (
                                            <div key={p.uid} className={`p-2 rounded-xl text-center text-sm font-bold border transition-all relative ${isTurn ? 'glow-blue bg-blue-900/30 text-blue-100' : isTarget ? 'glow-orange bg-orange-900/30 text-orange-100' : 'border-transparent bg-black/20'}`}>
                                                {isTurn && <span className="absolute -top-1 -left-1 text-[9px] bg-blue-600 text-white px-1 rounded-full shadow-lg">ì§ˆë¬¸</span>}
                                                {isTarget && <span className="absolute -top-1 -right-1 text-[9px] bg-orange-600 text-white px-1 rounded-full shadow-lg">ë‹µë³€</span>}
                                                <div className="truncate">{p.name} {p.uid === userId && '(ë‚˜)'}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* ì±„íŒ… & ë¡œê·¸ */}
                            <div className="flex-1 min-h-0 flex flex-col md:flex-row gap-3 mb-16 md:mb-20">
                                <div className="flex-1 h-full"><ChatArea messages={messages} chatInput={chatInput} setChatInput={setChatInput} sendMessage={sendMessage} myNickname={nickname} placeholderText={chatPlaceholder} /></div>
                                <div className="flex-1 h-full hidden md:block"><PlayerLog players={players} messages={messages} /></div>
                            </div>

                            {/* í„´ ì•Œë¦¼ */}
                            {turnNotification && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-6 modal-enter" onClick={() => setTurnNotification(null)}>
                                    <div className={`w-full max-w-sm p-8 rounded-[2rem] text-center shadow-2xl border-4 ${turnNotification.color} bg-gray-900 relative`} onClick={e => e.stopPropagation()}>
                                        <div className="text-6xl mb-4 animate-bounce">{turnNotification.type === 'ask' ? 'ğŸ—£ï¸' : 'ğŸ’¬'}</div><h2 className="text-3xl font-black mb-3 text-white">{turnNotification.title}</h2><p className="text-gray-300 text-lg mb-8 font-medium leading-relaxed">{turnNotification.message}</p><button onClick={() => setTurnNotification(null)} className="w-full bg-white text-black py-4 rounded-xl font-bold text-lg hover:bg-gray-200 transition-colors">í™•ì¸í–ˆìŠµë‹ˆë‹¤ (ë‹«ê¸°)</button>
                                    </div>
                                </div>
                            )}
                            
                            {/* ê²°ê³¼ í™”ë©´ */}
                            {showResultModal && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-6 modal-enter">
                                    <div className="glass-card w-full max-w-md rounded-3xl p-6 max-h-[90vh] overflow-y-auto border border-white/20">
                                        <h2 className="text-3xl font-black text-center mb-1 text-yellow-400">ê²Œì„ ì¢…ë£Œ</h2>
                                        <p className="text-center text-white/50 text-sm mb-4">{roomData.endReason}</p>
                                        <div className="bg-white/10 rounded-xl p-3 my-4 text-center"><div className="text-xs text-gray-400">ì¥ì†Œ</div><div className="text-2xl font-bold text-white">{roomData.locationName}</div></div>
                                        <div className="space-y-3 mb-6">{players.map(p => (<div key={p.uid} className={`flex justify-between items-center p-3 rounded-xl ${p.isSpy ? 'bg-red-900/40 border border-red-500/50' : 'bg-black/30 border border-white/5'}`}><span className="font-bold text-white">{p.name}</span><span className={`font-bold ${p.isSpy ? 'text-red-400' : 'text-blue-300'}`}>{p.isSpy ? 'ìŠ¤íŒŒì´ ğŸ•µï¸' : p.role}</span></div>))}</div>
                                        <div className="flex gap-3"><button onClick={leaveRoomCleanup} className="flex-1 bg-gray-600 hover:bg-gray-500 py-4 rounded-xl font-bold text-white shadow-lg">ë©”ì¸ìœ¼ë¡œ</button>{isHost && <button onClick={handleRestart} className="flex-1 bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-white shadow-lg">ìƒˆ ê²Œì„</button>}</div>
                                    </div>
                                </div>
                            )}

                            {/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */}
                            <div className="fixed bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-[#020617] via-[#020617] to-transparent pt-6 z-20 pointer-events-none">
                                <div className="max-w-5xl mx-auto pointer-events-auto">
                                    {isHost && (roomData.status === 'playing' ? <button onClick={() => handleEndGame("ë°©ì¥ì´ ê²Œì„ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.")} className="w-full bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold shadow-lg border-t border-red-400 text-white">ğŸ›‘ ê²Œì„ ì¢…ë£Œ ë° ê³µê°œ</button> : <button onClick={handleStartGame} disabled={players.length < 3} className="w-full bg-green-600 hover:bg-green-500 disabled:bg-gray-700 py-4 rounded-xl font-bold shadow-lg border-t border-green-400 text-white text-lg">ê²Œì„ ì‹œì‘ ({players.length}/3)</button>)}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>