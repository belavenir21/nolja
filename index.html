<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPYFALL - ì˜¨ë¼ì¸ ìŠ¤íŒŒì´ ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDvtMrhYYEqpJEjwhBzEiyKgBhmcoLKROM",
            authDomain: "spyfall-b107.firebaseapp.com",
            databaseURL: "https://spyfall-b107-default-rtdb.firebaseio.com",
            projectId: "spyfall-b107",
            storageBucket: "spyfall-b107.firebasestorage.app",
            messagingSenderId: "35799604494",
            appId: "1:35799604494:web:9558db68aa6c5347d60b5f",
            measurementId: "G-HYQR22H174"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        const GAME_DATA = {
            hospital: { place: "ğŸ¥ ì¢…í•©ë³‘ì›", roles: ["ì™¸ê³¼ ì˜ì‚¬", "ìˆ˜ê°„í˜¸ì‚¬", "ì‘ê¸‰ í™˜ì", "ë³‘ì›ì¥", "êµ¬ê¸‰ëŒ€ì›", "ì•½ì‚¬", "ì²­ì†Œë¶€", "ë³´í˜¸ì"] },
            school: { place: "ğŸ« ê³ ë“±í•™êµ", roles: ["ë‹´ì„ ì„ ìƒë‹˜", "ì „êµ íšŒì¥", "ì²´ìœ¡ ì„ ìƒë‹˜", "êµì¥ ì„ ìƒë‹˜", "ë§¤ì  ì´ëª¨", "ì ìëŠ” í•™ìƒ", "ì „í•™ìƒ", "ì–‘í˜¸ ì„ ìƒë‹˜"] },
            airplane: { place: "âœˆï¸ ë¹„í–‰ê¸°", roles: ["ê¸°ì¥", "ìŠ¹ë¬´ì›", "ì¼ë“±ì„ ìŠ¹ê°", "ìš°ëŠ” ì•„ê¸°", "ê¸°ë‚´ì‹ ìš”ë¦¬ì‚¬", "í•­ê³µ ë³´ì•ˆê´€", "ì •ë¹„ì‚¬", "ë¶€ê¸°ì¥"] },
            pirate: { place: "ğŸ´â€â˜ ï¸ í•´ì ì„ ", roles: ["í•´ì  ì„ ì¥", "ìš©ê°í•œ ì„ ì›", "í¬ë¡œ", "ìš”ë¦¬ì‚¬", "ì¡°íƒ€ìˆ˜", "ê°‘íŒì¥", "ì•µë¬´ìƒˆ", "ë§ì›ê²½ ë³´ëŠ” ì„ ì›"] },
            movie: { place: "ğŸ¬ ì˜í™” ì´¬ì˜ì¥", roles: ["ì˜í™” ê°ë…", "ì£¼ì—° ë°°ìš°", "ìŠ¤í„´íŠ¸ë§¨", "ì¹´ë©”ë¼ ê°ë…", "ë¶„ì¥ì‚¬", "ì—‘ìŠ¤íŠ¸ë¼", "ì‘ê°€", "ì¡°ëª… ê°ë…"] },
            casino: { place: "ğŸ° ì¹´ì§€ë…¸", roles: ["ë”œëŸ¬", "ë¶€ì ì†ë‹˜", "ë³´ì•ˆ ìš”ì›", "ë§¤ë‹ˆì €", "ëˆ ìƒì€ ì†ë‹˜", "ë°”í…ë”", "íƒ€ì§œ", "ì²­ì†Œë¶€"] },
            space: { place: "ğŸš€ ìš°ì£¼ ì •ê±°ì¥", roles: ["ìš°ì£¼ ë¹„í–‰ì‚¬", "í•¨ì¥", "ì™¸ê³„ì¸ ì—°êµ¬ì›", "ì—”ì§€ë‹ˆì–´", "ìš°ì£¼ ê´€ê´‘ê°", "AI ë¡œë´‡", "ì˜ë¬´ê´€", "í†µì‹  ì¥êµ"] },
            army: { place: "â›º êµ°ë¶€ëŒ€", roles: ["ì§€íœ˜ê´€", "ì‹ ë³‘", "ì·¨ì‚¬ë³‘", "ì¡°êµ", "ì˜ë¬´ë³‘", "íƒˆì˜ë³‘", "í–‰ë³´ê´€", "ì‚¬ê²© êµê´€"] },
            opera: { place: "ğŸ­ ì˜¤í˜ë¼ í•˜ìš°ìŠ¤", roles: ["ì˜¤í˜ë¼ ê°€ìˆ˜", "ì§€íœ˜ì", "ì—°ì£¼ì", "VIP ê´€ê°", "ë¬´ëŒ€ ê°ë…", "ì•ˆë‚´ì›", "ë§¤í‘œì†Œ ì§ì›", "ì¡°ëª… ê¸°ì‚¬"] },
            camping: { place: "â›º ìº í•‘ì¥", roles: ["ê³ ê¸° êµ½ëŠ” ì•„ë¹ ", "ë›°ì–´ë…¸ëŠ” ì•„ì´", "ìº í•‘ì¥ ì£¼ì¸", "ìˆ  ì·¨í•œ ëŒ€í•™ìƒ", "ê¸°íƒ€ ì¹˜ëŠ” ì‚¬ëŒ", "ëª¨ê¸° ë¬¼ë¦° ì‚¬ëŒ", "ì¥ì‘ íŒŒëŠ” ì‚¬ëŒ", "ì˜† í…íŠ¸ ì»¤í”Œ"] },
            cruise: { place: "ğŸš¢ í¬ë£¨ì¦ˆ ìœ ëŒì„ ", roles: ["ì„ ì¥", "ë°”í…ë”", "ë§ˆìˆ ì‚¬", "ì‹ í˜¼ë¶€ë¶€", "ê°‘ë¶€ ë…¸ì¸", "ìˆ˜ì˜ì¥ ì•ˆì „ìš”ì›", "ì¹´ì§€ë…¸ ë”œëŸ¬", "ê°ì‹¤ ì²­ì†Œë¶€"] },
            bank: { place: "ğŸ¦ ì€í–‰", roles: ["ì€í–‰ ê°•ë„", "ì§€ì ì¥", "ì°½êµ¬ ì§ì›", "ëŒ€ì¶œ ìƒë‹´ ë°›ìœ¼ëŸ¬ ì˜¨ ì‚¬ëŒ", "ì²­ì› ê²½ì°°", "ATM ìˆ˜ë¦¬ê¸°ì‚¬", "í˜„ê¸ˆ ìˆ˜ì†¡ ìš”ì›", "VIP ê³ ê°"] }
        };

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substring(2, 15);
        }

        function getRandomLocation() {
            const keys = Object.keys(GAME_DATA);
            return GAME_DATA[keys[Math.floor(Math.random() * keys.length)]];
        }

        function App() {
            const getUserId = () => {
                const stored = localStorage.getItem('spyfall_user_id');
                if (stored) return stored;
                const newId = generateUserId();
                localStorage.setItem('spyfall_user_id', newId);
                return newId;
            };

            const [userId] = useState(getUserId);
            const [view, setView] = useState('lobby');
            const [roomId, setRoomId] = useState('');
            const [nickname, setNickname] = useState('');
            const [roomData, setRoomData] = useState(null);
            const [error, setError] = useState('');

            useEffect(() => {
                if (!roomId) return;

                const roomRef = database.ref('rooms/' + roomId);
                
                const listener = roomRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setRoomData(data);
                        if (data.status === 'playing' && view !== 'game') {
                            setView('game');
                        } else if (data.status === 'waiting' && view === 'game') {
                            setView('room');
                        }
                    } else {
                        alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                        setView('lobby');
                        setRoomId('');
                    }
                });

                return () => {
                    roomRef.off('value', listener);
                };
            }, [roomId, view]);

            const handleCreateRoom = async () => {
                if (!nickname.trim()) { 
                    setError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”'); 
                    return; 
                }
                
                const newRoomId = generateRoomCode();
                const newPlayer = {
                    uid: userId, 
                    name: nickname, 
                    role: null, 
                    isSpy: false 
                };

                const newRoomData = {
                    hostId: userId,
                    players: {},
                    status: 'waiting',
                    createdAt: Date.now(),
                    locationName: null
                };
                newRoomData.players[userId] = newPlayer;

                try {
                    await database.ref('rooms/' + newRoomId).set(newRoomData);
                    setRoomId(newRoomId);
                    setView('room');
                    setError('');
                } catch (e) {
                    setError('ë°© ìƒì„± ì‹¤íŒ¨');
                }
            };

            const handleJoinRoom = async () => {
                if (!nickname.trim() || !roomId.trim()) { 
                    setError('ë‹‰ë„¤ì„ê³¼ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”'); 
                    return; 
                }
                
                const targetId = roomId.toUpperCase();
                
                try {
                    const snapshot = await database.ref('rooms/' + targetId).once('value');
                    const data = snapshot.val();
                    
                    if (!data) { 
                        setError('ë°©ì´ ì—†ìŠµë‹ˆë‹¤'); 
                        return; 
                    }
                    if (data.status === 'playing') { 
                        setError('ê²Œì„ ì§„í–‰ ì¤‘'); 
                        return; 
                    }
                    
                    const players = data.players || {};
                    const playerCount = Object.keys(players).length;
                    if (playerCount >= 12) { 
                        setError('ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤'); 
                        return; 
                    }

                    const newPlayer = {
                        uid: userId,
                        name: nickname,
                        role: null,
                        isSpy: false
                    };

                    await database.ref('rooms/' + targetId + '/players/' + userId).set(newPlayer);

                    setRoomId(targetId);
                    setView('room');
                    setError('');
                } catch (e) {
                    setError('ì…ì¥ ì‹¤íŒ¨');
                }
            };

            const handleStartGame = async () => {
                if (!roomData || roomData.hostId !== userId) return;
                
                const playersObj = roomData.players || {};
                const players = Object.values(playersObj);
                
                if (players.length < 3) { 
                    alert('ìµœì†Œ 3ëª… í•„ìš”'); 
                    return; 
                }

                const location = getRandomLocation();
                const roles = location.roles.slice();
                const spyIndex = Math.floor(Math.random() * players.length);
                
                const updatedPlayers = {};
                
                for (let i = 0; i < players.length; i++) {
                    const p = players[i];
                    if (i === spyIndex) {
                        updatedPlayers[p.uid] = {
                            uid: p.uid,
                            name: p.name,
                            role: 'SPY',
                            isSpy: true
                        };
                    } else {
                        let role = "ì‹œë¯¼";
                        if (roles.length > 0) {
                            const randomIndex = Math.floor(Math.random() * roles.length);
                            role = roles[randomIndex];
                            roles.splice(randomIndex, 1);
                        }
                        updatedPlayers[p.uid] = {
                            uid: p.uid,
                            name: p.name,
                            role: role,
                            isSpy: false
                        };
                    }
                }

                const updates = {
                    status: 'playing',
                    locationName: location.place,
                    players: updatedPlayers
                };

                await database.ref('rooms/' + roomId).update(updates);
            };

            const handleReset = async () => {
                if (!roomData || roomData.hostId !== userId) return;
                
                const playersObj = roomData.players || {};
                const players = Object.values(playersObj);
                const resetPlayers = {};
                
                for (let i = 0; i < players.length; i++) {
                    const p = players[i];
                    resetPlayers[p.uid] = {
                        uid: p.uid,
                        name: p.name,
                        role: null,
                        isSpy: false
                    };
                }

                const updates = {
                    status: 'waiting',
                    locationName: null,
                    players: resetPlayers
                };

                await database.ref('rooms/' + roomId).update(updates);
            };

            const copyCode = () => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(roomId).then(() => {
                        alert('ë³µì‚¬ë¨: ' + roomId);
                    }).catch(() => {
                        prompt('ë³µì‚¬í•˜ì„¸ìš”:', roomId);
                    });
                } else {
                    prompt('ë³µì‚¬í•˜ì„¸ìš”:', roomId);
                }
            };

            if (view === 'lobby') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
                        <div className="max-w-md w-full space-y-6">
                            <div className="text-center space-y-3">
                                <div className="text-7xl">ğŸ•µï¸</div>
                                <h1 className="text-6xl font-black text-white tracking-tight">SPYFALL</h1>
                                <p className="text-purple-300 text-lg">ìŠ¤íŒŒì´ë¥¼ ì°¾ì•„ë¼</p>
                            </div>

                            <input
                                value={nickname}
                                onChange={(e) => setNickname(e.target.value)}
                                placeholder="ë‹‰ë„¤ì„"
                                className="w-full px-6 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-2xl text-white text-lg placeholder-white/50 focus:outline-none focus:border-purple-400"
                            />

                            {error && <div className="bg-red-500/20 border border-red-400 rounded-xl p-3 text-red-200 text-center">{error}</div>}

                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={handleCreateRoom} className="bg-gradient-to-br from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-6 rounded-2xl shadow-lg transform hover:scale-105 transition">
                                    ë°© ë§Œë“¤ê¸°
                                </button>
                                <button onClick={() => setView('join')} className="bg-gradient-to-br from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-6 rounded-2xl shadow-lg transform hover:scale-105 transition">
                                    ì°¸ê°€í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'join') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4">
                        <div className="max-w-md w-full space-y-4">
                            <h2 className="text-4xl font-bold text-white text-center mb-6">ë°© ì°¸ê°€</h2>
                            <input value={nickname} onChange={(e) => setNickname(e.target.value)} placeholder="ë‹‰ë„¤ì„" className="w-full px-6 py-4 bg-white/10 border-2 border-white/20 rounded-xl text-white" />
                            <input value={roomId} onChange={(e) => setRoomId(e.target.value.toUpperCase())} placeholder="ë°© ì½”ë“œ (4ìë¦¬)" maxLength={4} className="w-full px-6 py-4 bg-white/10 border-2 border-white/20 rounded-xl text-white text-center text-2xl tracking-widest uppercase" />
                            {error && <div className="text-red-300 text-center">{error}</div>}
                            <button onClick={handleJoinRoom} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-xl">ì…ì¥</button>
                            <button onClick={() => setView('lobby')} className="w-full text-white/70 hover:text-white">ì·¨ì†Œ</button>
                        </div>
                    </div>
                );
            }

            if (view === 'room' && roomData) {
                const isHost = roomData.hostId === userId;
                const playersObj = roomData.players || {};
                const players = Object.values(playersObj);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 p-4">
                        <div className="max-w-2xl mx-auto pt-12 space-y-6">
                            <div className="bg-white/10 backdrop-blur rounded-3xl p-8 text-center border-2 border-white/20">
                                <div className="text-sm text-white/60 mb-2">ë°© ì½”ë“œ</div>
                                <div className="text-6xl font-black text-white tracking-widest mb-4">{roomId}</div>
                                <button onClick={copyCode} className="bg-emerald-500 hover:bg-emerald-600 px-6 py-2 rounded-xl text-white font-bold">ë³µì‚¬</button>
                            </div>

                            <div className="bg-white/10 backdrop-blur rounded-3xl p-6 border-2 border-white/20">
                                <h3 className="text-xl font-bold text-white mb-4">ì°¸ê°€ì ({players.length}ëª…)</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {players.map((p, i) => (
                                        <div key={i} className="bg-white/10 rounded-xl p-4 text-white font-medium text-center">
                                            {p.name} {p.uid === userId ? 'ğŸ‘¤' : ''} {p.uid === roomData.hostId ? 'ğŸ‘‘' : ''}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {isHost ? (
                                <button onClick={handleStartGame} disabled={players.length < 3} className="w-full bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 disabled:opacity-50 text-white font-bold py-5 rounded-2xl text-xl">
                                    ê²Œì„ ì‹œì‘
                                </button>
                            ) : (
                                <div className="text-center text-yellow-300 text-lg">ë°©ì¥ì´ ì‹œì‘í•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...</div>
                            )}
                        </div>
                    </div>
                );
            }

            if (view === 'game' && roomData) {
                const playersObj = roomData.players || {};
                const players = Object.values(playersObj);
                let me = null;
                for (let i = 0; i < players.length; i++) {
                    if (players[i].uid === userId) {
                        me = players[i];
                        break;
                    }
                }
                const isHost = roomData.hostId === userId;

                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-rose-900 to-slate-900 p-4">
                        <div className="max-w-2xl mx-auto pt-12 space-y-6">
                            {me && (
                                <div className={me.isSpy ? 'bg-gradient-to-br from-red-600 to-rose-700 rounded-3xl p-8 text-center border-4 border-white/30 shadow-2xl' : 'bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-8 text-center border-4 border-white/30 shadow-2xl'}>
                                    <div className="text-6xl mb-4">{me.isSpy ? 'ğŸ•µï¸' : 'ğŸ­'}</div>
                                    {me.isSpy ? (
                                        <div>
                                            <div className="text-3xl font-black text-white mb-2">ë‹¹ì‹ ì€ ìŠ¤íŒŒì´!</div>
                                            <div className="text-white/80">ì¥ì†Œë¥¼ ëª¨ë¦…ë‹ˆë‹¤. ë“¤í‚¤ì§€ ë§ê³  ì•Œì•„ë‚´ì„¸ìš”!</div>
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="text-white/80 text-sm mb-1">ë‹¹ì‹ ì˜ ì—­í• </div>
                                            <div className="text-4xl font-black text-white mb-4">{me.role}</div>
                                            <div className="border-t-2 border-white/30 pt-4">
                                                <div className="text-white/80 text-sm mb-1">ì¥ì†Œ</div>
                                                <div className="text-3xl font-bold text-white">{roomData.locationName}</div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="bg-white/10 backdrop-blur rounded-3xl p-6 border-2 border-white/20">
                                <h3 className="text-xl font-bold text-white mb-4">í”Œë ˆì´ì–´</h3>
                                <div className="grid grid-cols-3 gap-3">
                                    {players.map((p, i) => (
                                        <div key={i} className="bg-white/10 rounded-xl p-3 text-white text-center font-medium">{p.name}</div>
                                    ))}
                                </div>
                            </div>

                            {isHost && (
                                <button onClick={handleReset} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-2xl">
                                    ê²Œì„ ì¢…ë£Œ
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            return <div className="min-h-screen bg-slate-900 text-white flex items-center justify-center">Loading...</div>;
        }

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>