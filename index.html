<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPYFALL - ì˜¨ë¼ì¸ ìŠ¤íŒŒì´ ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .spy-gradient { background: linear-gradient(135deg, #1a1c2c 0%, #4a192c 100%); }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ğŸ”¥ ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase ì„¤ì •ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ğŸ”¥
        const firebaseConfig = {
            apiKey: "AIzaSyDvtMrhYYEqpJEjwhBzEiyKgBhmcoLKROM",
            authDomain: "spyfall-b107.firebaseapp.com",
            databaseURL: "https://spyfall-b107-default-rtdb.firebaseio.com",
            projectId: "spyfall-b107",
            storageBucket: "spyfall-b107.firebasestorage.app",
            messagingSenderId: "35799604494",
            appId: "1:35799604494:web:9558db68aa6c5347d60b5f",
            measurementId: "G-HYQR22H174"
        };

        // Firebase ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ì²´í¬)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // ê²Œì„ ë°ì´í„°
        const GAME_DATA = {
            hospital: { place: "ğŸ¥ ì¢…í•©ë³‘ì›", roles: ["ì™¸ê³¼ ì˜ì‚¬", "ìˆ˜ê°„í˜¸ì‚¬", "ì‘ê¸‰ í™˜ì", "ë³‘ì›ì¥", "êµ¬ê¸‰ëŒ€ì›", "ì•½ì‚¬", "ì²­ì†Œë¶€", "ë³´í˜¸ì"] },
            school: { place: "ğŸ« ê³ ë“±í•™êµ", roles: ["ë‹´ì„ ì„ ìƒë‹˜", "ì „êµ íšŒì¥", "ì²´ìœ¡ ì„ ìƒë‹˜", "êµì¥ ì„ ìƒë‹˜", "ë§¤ì  ì´ëª¨", "ì ìëŠ” í•™ìƒ", "ì „í•™ìƒ", "ì–‘í˜¸ ì„ ìƒë‹˜"] },
            airplane: { place: "âœˆï¸ ë¹„í–‰ê¸°", roles: ["ê¸°ì¥", "ìŠ¹ë¬´ì›", "ì¼ë“±ì„ ìŠ¹ê°", "ìš°ëŠ” ì•„ê¸°", "ê¸°ë‚´ì‹ ìš”ë¦¬ì‚¬", "í•­ê³µ ë³´ì•ˆê´€", "ì •ë¹„ì‚¬", "ë¶€ê¸°ì¥"] },
            pirate: { place: "ğŸ´â€â˜ ï¸ í•´ì ì„ ", roles: ["í•´ì  ì„ ì¥", "ìš©ê°í•œ ì„ ì›", "í¬ë¡œ", "ìš”ë¦¬ì‚¬", "ì¡°íƒ€ìˆ˜", "ê°‘íŒì¥", "ì•µë¬´ìƒˆ", "ë§ì›ê²½ ë³´ëŠ” ì„ ì›"] },
            movie: { place: "ğŸ¬ ì˜í™” ì´¬ì˜ì¥", roles: ["ì˜í™” ê°ë…", "ì£¼ì—° ë°°ìš°", "ìŠ¤í„´íŠ¸ë§¨", "ì¹´ë©”ë¼ ê°ë…", "ë¶„ì¥ì‚¬", "ì—‘ìŠ¤íŠ¸ë¼", "ì‘ê°€", "ì¡°ëª… ê°ë…"] },
            casino: { place: "ğŸ° ì¹´ì§€ë…¸", roles: ["ë”œëŸ¬", "ë¶€ì ì†ë‹˜", "ë³´ì•ˆ ìš”ì›", "ë§¤ë‹ˆì €", "ëˆ ìƒì€ ì†ë‹˜", "ë°”í…ë”", "íƒ€ì§œ", "ì²­ì†Œë¶€"] },
            space: { place: "ğŸš€ ìš°ì£¼ ì •ê±°ì¥", roles: ["ìš°ì£¼ ë¹„í–‰ì‚¬", "í•¨ì¥", "ì™¸ê³„ì¸ ì—°êµ¬ì›", "ì—”ì§€ë‹ˆì–´", "ìš°ì£¼ ê´€ê´‘ê°", "AI ë¡œë´‡", "ì˜ë¬´ê´€", "í†µì‹  ì¥êµ"] },
            army: { place: "â›º êµ°ë¶€ëŒ€", roles: ["ì§€íœ˜ê´€", "ì‹ ë³‘", "ì·¨ì‚¬ë³‘", "ì¡°êµ", "ì˜ë¬´ë³‘", "íƒˆì˜ë³‘", "í–‰ë³´ê´€", "ì‚¬ê²© êµê´€"] },
            opera: { place: "ğŸ­ ì˜¤í˜ë¼ í•˜ìš°ìŠ¤", roles: ["ì˜¤í˜ë¼ ê°€ìˆ˜", "ì§€íœ˜ì", "ì—°ì£¼ì", "VIP ê´€ê°", "ë¬´ëŒ€ ê°ë…", "ì•ˆë‚´ì›", "ë§¤í‘œì†Œ ì§ì›", "ì¡°ëª… ê¸°ì‚¬"] },
            camping: { place: "â›º ìº í•‘ì¥", roles: ["ê³ ê¸° êµ½ëŠ” ì•„ë¹ ", "ë›°ì–´ë…¸ëŠ” ì•„ì´", "ìº í•‘ì¥ ì£¼ì¸", "ìˆ  ì·¨í•œ ëŒ€í•™ìƒ", "ê¸°íƒ€ ì¹˜ëŠ” ì‚¬ëŒ", "ëª¨ê¸° ë¬¼ë¦° ì‚¬ëŒ", "ì¥ì‘ íŒŒëŠ” ì‚¬ëŒ", "ì˜† í…íŠ¸ ì»¤í”Œ"] },
            cruise: { place: "ğŸš¢ í¬ë£¨ì¦ˆ ìœ ëŒì„ ", roles: ["ì„ ì¥", "ë°”í…ë”", "ë§ˆìˆ ì‚¬", "ì‹ í˜¼ë¶€ë¶€", "ê°‘ë¶€ ë…¸ì¸", "ìˆ˜ì˜ì¥ ì•ˆì „ìš”ì›", "ì¹´ì§€ë…¸ ë”œëŸ¬", "ê°ì‹¤ ì²­ì†Œë¶€"] },
            bank: { place: "ğŸ¦ ì€í–‰", roles: ["ì€í–‰ ê°•ë„", "ì§€ì ì¥", "ì°½êµ¬ ì§ì›", "ëŒ€ì¶œ ìƒë‹´ ë°›ìœ¼ëŸ¬ ì˜¨ ì‚¬ëŒ", "ì²­ì› ê²½ì°°", "ATM ìˆ˜ë¦¬ê¸°ì‚¬", "í˜„ê¸ˆ ìˆ˜ì†¡ ìš”ì›", "VIP ê³ ê°"] }
        };

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substring(2, 15);
        }

        function getRandomLocation() {
            const keys = Object.keys(GAME_DATA);
            return GAME_DATA[keys[Math.floor(Math.random() * keys.length)]];
        }

        function App() {
            // ìœ ì € ID ê´€ë¦¬
            const [userId] = useState(() => {
                const stored = localStorage.getItem('spyfall_user_id');
                if (stored) return stored;
                const newId = generateUserId();
                localStorage.setItem('spyfall_user_id', newId);
                return newId;
            });

            // ìƒíƒœ ê´€ë¦¬
            const [view, setView] = useState('lobby'); // lobby, room, game
            const [roomId, setRoomId] = useState('');
            const [nickname, setNickname] = useState(localStorage.getItem('spyfall_nickname') || '');
            const [roomData, setRoomData] = useState(null);
            const [error, setError] = useState('');

            // ë‹‰ë„¤ì„ ì €ì¥
            useEffect(() => {
                if (nickname) localStorage.setItem('spyfall_nickname', nickname);
            }, [nickname]);

            // ìƒˆë¡œê³ ì¹¨ ì‹œ ë°© ì¬ì ‘ì† ì‹œë„
            useEffect(() => {
                const savedRoomId = localStorage.getItem('spyfall_current_room');
                if (savedRoomId && view === 'lobby') {
                    // ë°© ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸ í›„ ì¬ì ‘ì†
                    database.ref('rooms/' + savedRoomId).once('value', snapshot => {
                        if (snapshot.exists()) {
                            setRoomId(savedRoomId);
                            setView('room'); // ì¼ë‹¨ roomìœ¼ë¡œ ë³´ë‚´ê³  ë¦¬ìŠ¤ë„ˆê°€ gameìœ¼ë¡œ ë³´ëƒ„
                        } else {
                            localStorage.removeItem('spyfall_current_room');
                        }
                    });
                }
            }, []);

            // ë°© ë°ì´í„° ë¦¬ìŠ¤ë„ˆ & ìë™ í‡´ì¥ ì„¤ì • (í•µì‹¬ ê¸°ëŠ¥!)
            useEffect(() => {
                if (!roomId) return;
                
                // 1. ë°© ì •ë³´ êµ¬ë…
                const roomRef = database.ref('rooms/' + roomId);
                const listener = roomRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setRoomData(data);
                        if (data.status === 'playing') setView('game');
                        else if (data.status === 'waiting') setView('room');
                        
                        // í˜„ì¬ ì ‘ì† ì¤‘ì„ì„ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
                        localStorage.setItem('spyfall_current_room', roomId);
                    } else {
                        // ë°©ì´ ì‚¬ë¼ì§
                        alert('ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        leaveRoomCleanup();
                    }
                });

                // 2. ğŸ”¥ ìë™ í‡´ì¥(onDisconnect) ì„¤ì • ğŸ”¥
                // ë‚´ í”Œë ˆì´ì–´ ë°ì´í„° ê²½ë¡œ
                const myPlayerRef = database.ref('rooms/' + roomId + '/players/' + userId);
                
                // ì—°ê²° ëŠê¸°ë©´(ì°½ ë‹«ìœ¼ë©´) ë‚´ ë°ì´í„° ì‚­ì œ ì˜ˆì•½
                myPlayerRef.onDisconnect().remove();

                // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ(ë‚˜ê°€ê¸° ë²„íŠ¼ ë“±) ë¦¬ìŠ¤ë„ˆ í•´ì œ
                return () => {
                    roomRef.off('value', listener);
                };
            }, [roomId, userId]);

            // ë°© ë‚˜ê°€ê¸°/ì¢…ë£Œ ì‹œ ì •ë¦¬ í•¨ìˆ˜
            const leaveRoomCleanup = async () => {
                if (roomId) {
                    // 1. ì˜ˆì•½ëœ ìë™ í‡´ì¥ ì·¨ì†Œ (ì´ë¯¸ ë‚˜ê°ˆ ê±°ë‹ˆê¹Œ)
                    const myPlayerRef = database.ref('rooms/' + roomId + '/players/' + userId);
                    myPlayerRef.onDisconnect().cancel(); 

                    // 2. ì‹¤ì œ ë°ì´í„° ì‚­ì œ
                    await myPlayerRef.remove();
                    
                    // 3. ë¡œì»¬ ìƒíƒœ ì •ë¦¬
                    localStorage.removeItem('spyfall_current_room');
                    setRoomId('');
                    setRoomData(null);
                    setView('lobby');
                }
            };

            const handleCreateRoom = async () => {
                if (!nickname.trim()) return setError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
                
                const newRoomId = generateRoomCode();
                const newPlayer = { uid: userId, name: nickname, role: null, isSpy: false };

                const newRoomData = {
                    hostId: userId,
                    players: { [userId]: newPlayer },
                    status: 'waiting',
                    createdAt: Date.now(),
                    locationName: null
                };

                try {
                    await database.ref('rooms/' + newRoomId).set(newRoomData);
                    setRoomId(newRoomId);
                    setView('room');
                    setError('');
                } catch (e) {
                    setError('ë°© ìƒì„± ì‹¤íŒ¨: ' + e.message);
                }
            };

            const handleJoinRoom = async () => {
                if (!nickname.trim() || !roomId.trim()) return setError('ë‹‰ë„¤ì„ê³¼ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                
                const targetId = roomId.toUpperCase();
                
                try {
                    const snapshot = await database.ref('rooms/' + targetId).once('value');
                    const data = snapshot.val();
                    
                    if (!data) return setError('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤');
                    if (data.status === 'playing') return setError('ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤');
                    
                    const players = data.players || {};
                    if (Object.keys(players).length >= 12) return setError('ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤');

                    // í”Œë ˆì´ì–´ ì¶”ê°€
                    const newPlayer = { uid: userId, name: nickname, role: null, isSpy: false };
                    await database.ref('rooms/' + targetId + '/players/' + userId).set(newPlayer);

                    setRoomId(targetId);
                    setView('room');
                    setError('');
                } catch (e) {
                    setError('ì…ì¥ ì‹¤íŒ¨: ' + e.message);
                }
            };

            const handleStartGame = async () => {
                if (!roomData || roomData.hostId !== userId) return;
                
                const players = Object.values(roomData.players || {});
                if (players.length < 3) return alert('ìµœì†Œ 3ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤');

                const location = getRandomLocation();
                let roles = [...location.roles];
                // ì—­í•  ì…”í”Œ
                roles.sort(() => Math.random() - 0.5);

                const spyIndex = Math.floor(Math.random() * players.length);
                const updatedPlayers = {};

                players.forEach((p, index) => {
                    let playerRole = "ì‹œë¯¼";
                    let isSpy = false;

                    if (index === spyIndex) {
                        playerRole = "SPY";
                        isSpy = true;
                    } else if (roles.length > 0) {
                        playerRole = roles.pop();
                    }

                    updatedPlayers[p.uid] = {
                        ...p,
                        role: playerRole,
                        isSpy: isSpy
                    };
                });

                await database.ref('rooms/' + roomId).update({
                    status: 'playing',
                    locationName: location.place,
                    players: updatedPlayers
                });
            };

            const handleResetGame = async () => {
                if (!roomData || roomData.hostId !== userId) return;
                
                const players = Object.values(roomData.players || {});
                const resetPlayers = {};
                
                players.forEach(p => {
                    resetPlayers[p.uid] = { ...p, role: null, isSpy: false };
                });

                await database.ref('rooms/' + roomId).update({
                    status: 'waiting',
                    locationName: null,
                    players: resetPlayers
                });
            };

            const copyCode = () => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(roomId).then(() => alert('ë°© ì½”ë“œ ë³µì‚¬ ì™„ë£Œ!'));
                } else {
                    prompt("ë°© ì½”ë“œ:", roomId);
                }
            };

            // --- UI ë Œë”ë§ ---
            if (view === 'lobby') {
                return (
                    <div className="min-h-screen spy-gradient flex items-center justify-center p-4">
                        <div className="max-w-md w-full space-y-8 text-center">
                            <div>
                                <div className="text-6xl mb-2">ğŸ•µï¸</div>
                                <h1 className="text-5xl font-black tracking-tighter">SPYFALL</h1>
                                <p className="text-gray-400">ì‹¤ì‹œê°„ ì˜¨ë¼ì¸ ë©€í‹°í”Œë ˆì´</p>
                            </div>
                            
                            <div className="bg-white/10 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-white/10">
                                <input value={nickname} onChange={e => setNickname(e.target.value)} placeholder="ë‹‰ë„¤ì„ ì…ë ¥" className="w-full bg-black/30 border border-white/20 rounded-xl px-4 py-3 text-white mb-4 focus:outline-none focus:border-red-500 transition" />
                                
                                {error && <div className="bg-red-500/20 text-red-200 text-sm p-2 rounded mb-4">{error}</div>}

                                <button onClick={handleCreateRoom} className="w-full bg-red-600 hover:bg-red-700 py-4 rounded-xl font-bold text-lg mb-3 shadow-lg transition transform active:scale-95">ë°© ë§Œë“¤ê¸°</button>
                                
                                <div className="flex gap-2">
                                    <input value={roomId} onChange={e => setRoomId(e.target.value.toUpperCase())} placeholder="ì½”ë“œ" maxLength={4} className="w-1/3 bg-black/30 border border-white/20 rounded-xl px-4 py-3 text-white text-center tracking-widest uppercase focus:outline-none focus:border-blue-500" />
                                    <button onClick={handleJoinRoom} className="w-2/3 bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95">ì°¸ê°€í•˜ê¸°</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'room' || view === 'game') {
                if (!roomData) return <div className="min-h-screen spy-gradient flex items-center justify-center">ë¡œë”© ì¤‘...</div>;
                
                const players = Object.values(roomData.players || {});
                const isHost = roomData.hostId === userId;
                const me = roomData.players[userId];

                return (
                    <div className="min-h-screen spy-gradient p-4">
                        <div className="max-w-lg mx-auto pt-8 space-y-6">
                            {/* ìƒë‹¨ ë°” */}
                            <div className="flex justify-between items-center bg-black/30 p-4 rounded-2xl border border-white/10">
                                <div>
                                    <span className="text-xs text-gray-400 block">ROOM CODE</span>
                                    <span className="text-2xl font-black text-yellow-400 tracking-widest">{roomId}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={copyCode} className="bg-white/10 p-2 rounded-lg hover:bg-white/20">ğŸ“‹</button>
                                    <button onClick={leaveRoomCleanup} className="bg-red-900/50 p-2 rounded-lg hover:bg-red-900/80 text-red-200 text-xs">ë‚˜ê°€ê¸°</button>
                                </div>
                            </div>

                            {/* ê²Œì„ í™”ë©´ */}
                            {view === 'game' && me ? (
                                <div className={`relative overflow-hidden rounded-3xl p-8 text-center shadow-2xl border-4 ${me.isSpy ? 'bg-red-900 border-red-500' : 'bg-blue-900 border-blue-500'}`}>
                                    <div className="text-6xl mb-4">{me.isSpy ? 'ğŸ¤«' : 'ğŸ“'}</div>
                                    <h2 className="text-2xl font-bold mb-2">{me.isSpy ? 'ë‹¹ì‹ ì€ ìŠ¤íŒŒì´!' : 'ë‹¹ì‹ ì˜ ì—­í• '}</h2>
                                    
                                    {me.isSpy ? (
                                        <p className="text-red-200 font-medium">ì¥ì†Œë¥¼ ëª¨ë¦…ë‹ˆë‹¤.<br/>ëŒ€í™”ë¥¼ ë“£ê³  ëˆˆì¹˜ê» í–‰ë™í•˜ì„¸ìš”!</p>
                                    ) : (
                                        <div>
                                            <div className="text-4xl font-black text-white mb-6">{me.role}</div>
                                            <div className="border-t border-white/20 pt-4">
                                                <p className="text-xs text-blue-200 mb-1">í˜„ì¬ ì¥ì†Œ</p>
                                                <p className="text-3xl font-bold text-yellow-300">{roomData.locationName}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                // ëŒ€ê¸° í™”ë©´
                                <div className="bg-white/10 backdrop-blur rounded-3xl p-8 text-center border border-white/10">
                                    <div className="text-4xl mb-4">â³</div>
                                    <h2 className="text-xl font-bold mb-2">ê²Œì„ ëŒ€ê¸° ì¤‘</h2>
                                    <p className="text-gray-400 text-sm">ì°¸ê°€ìê°€ ëª¨ë‘ ëª¨ì´ë©´ ì‹œì‘í•˜ì„¸ìš”</p>
                                </div>
                            )}

                            {/* ì°¸ê°€ì ëª©ë¡ */}
                            <div className="bg-black/20 rounded-3xl p-6 border border-white/5">
                                <h3 className="text-sm font-bold text-gray-400 mb-4 uppercase">ì°¸ê°€ì ({players.length}ëª…)</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {players.map(p => (
                                        <div key={p.uid} className={`p-3 rounded-xl text-center text-sm font-medium transition ${p.uid === userId ? 'bg-white text-black' : 'bg-white/10 text-gray-300'}`}>
                                            {p.name} {p.uid === roomData.hostId && 'ğŸ‘‘'}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* ë°©ì¥ ì»¨íŠ¸ë¡¤ */}
                            {isHost && (
                                <div className="fixed bottom-6 left-0 right-0 px-4 max-w-lg mx-auto">
                                    {view === 'room' ? (
                                        <button onClick={handleStartGame} disabled={players.length < 3} className="w-full bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:bg-gray-600 text-white font-bold py-4 rounded-2xl shadow-xl text-lg transition">
                                            ê²Œì„ ì‹œì‘
                                        </button>
                                    ) : (
                                        <button onClick={handleResetGame} className="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-2xl shadow-xl">
                                            ê²Œì„ ì¢…ë£Œ / ë‹¤ì‹œ í•˜ê¸°
                                        </button>
                                    )}
                                </div>
                            )}
                            <div className="h-20"></div> {/* í•˜ë‹¨ ì—¬ë°± */}
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>