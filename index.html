<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPYFALL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }
        .app-container { 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
            position: relative;
        }
        .glass { 
            background: rgba(20, 20, 30, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chat-area { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px;
        }
        .chat-input-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10,10,10,0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }
        .action-header {
            position: sticky;
            top: 0;
            z-index: 50;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .timer-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .card-select {
            transition: all 0.2s;
            cursor: pointer;
        }
        .card-select:hover { transform: translateY(-4px); }
        .card-select:active { transform: scale(0.95); }
        .phase-transition {
            animation: fadeScale 0.5s;
        }
        @keyframes fadeScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        .location-memo {
            max-height: 300px;
            overflow-y: auto;
        }
        .vote-bar {
            transition: width 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase ë¡œë”© ëŒ€ê¸°
        if (typeof firebase === 'undefined') {
            document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:white;background:#000;">Firebase ë¡œë”© ì¤‘...</div>';
            throw new Error('Firebase not loaded');
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDvtMrhYYEqpJEjwhBzEiyKgBhmcoLKROM",
            authDomain: "spyfall-b107.firebaseapp.com",
            databaseURL: "https://spyfall-b107-default-rtdb.firebaseio.com",
            projectId: "spyfall-b107",
            storageBucket: "spyfall-b107.firebasestorage.app",
            messagingSenderId: "35799604494",
            appId: "1:35799604494:web:9558db68aa6c5347d60b5f",
            measurementId: "G-HYQR22H174"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const LOCATIONS = {
            hospital: { name: "ğŸ¥ ì¢…í•©ë³‘ì›", roles: ["ì™¸ê³¼ ì˜ì‚¬", "ìˆ˜ê°„í˜¸ì‚¬", "ì‘ê¸‰ í™˜ì", "ë³‘ì›ì¥", "êµ¬ê¸‰ëŒ€ì›", "ì•½ì‚¬", "ì²­ì†Œë¶€", "ë³´í˜¸ì"] },
            school: { name: "ğŸ« ê³ ë“±í•™êµ", roles: ["ë‹´ì„ ì„ ìƒë‹˜", "ì „êµ íšŒì¥", "ì²´ìœ¡ ì„ ìƒë‹˜", "êµì¥ ì„ ìƒë‹˜", "ë§¤ì  ì´ëª¨", "ì ìëŠ” í•™ìƒ", "ì „í•™ìƒ", "ì–‘í˜¸ ì„ ìƒë‹˜"] },
            airplane: { name: "âœˆï¸ ë¹„í–‰ê¸°", roles: ["ê¸°ì¥", "ìŠ¹ë¬´ì›", "ì¼ë“±ì„ ìŠ¹ê°", "ìš°ëŠ” ì•„ê¸°", "ê¸°ë‚´ì‹ ìš”ë¦¬ì‚¬", "í•­ê³µ ë³´ì•ˆê´€", "ì •ë¹„ì‚¬", "ë¶€ê¸°ì¥"] },
            pirate: { name: "ğŸ´â€â˜ ï¸ í•´ì ì„ ", roles: ["í•´ì  ì„ ì¥", "ìš©ê°í•œ ì„ ì›", "í¬ë¡œ", "ìš”ë¦¬ì‚¬", "ì¡°íƒ€ìˆ˜", "ê°‘íŒì¥", "ì•µë¬´ìƒˆ", "ë§ì›ê²½ ë³´ëŠ” ì„ ì›"] },
            movie: { name: "ğŸ¬ ì˜í™” ì´¬ì˜ì¥", roles: ["ì˜í™” ê°ë…", "ì£¼ì—° ë°°ìš°", "ìŠ¤í„´íŠ¸ë§¨", "ì¹´ë©”ë¼ ê°ë…", "ë¶„ì¥ì‚¬", "ì—‘ìŠ¤íŠ¸ë¼", "ì‘ê°€", "ì¡°ëª… ê°ë…"] },
            casino: { name: "ğŸ° ì¹´ì§€ë…¸", roles: ["ë”œëŸ¬", "ë¶€ì ì†ë‹˜", "ë³´ì•ˆ ìš”ì›", "ë§¤ë‹ˆì €", "ëˆ ìƒì€ ì†ë‹˜", "ë°”í…ë”", "íƒ€ì§œ", "ì²­ì†Œë¶€"] }
        };

        const genCode = () => Math.random().toString(36).substring(2, 6).toUpperCase();
        const genUserId = () => 'u_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);

        function App() {
            const [userId] = useState(() => {
                let id = localStorage.getItem('spy_uid');
                if (!id) {
                    id = genUserId();
                    localStorage.setItem('spy_uid', id);
                }
                return id;
            });

            const [view, setView] = useState('lobby');
            const [roomId, setRoomId] = useState('');
            const [nickname, setNickname] = useState(localStorage.getItem('spy_nick') || '');
            const [roomData, setRoomData] = useState(null);
            const [messages, setMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [showRole, setShowRole] = useState(false);
            const [showLocations, setShowLocations] = useState(false);
            const [checkedLocations, setCheckedLocations] = useState({});
            const [error, setError] = useState('');

            const chatEndRef = useRef(null);
            const reconnectRef = useRef(null);

            useEffect(() => {
                if (nickname) localStorage.setItem('spy_nick', nickname);
            }, [nickname]);

            // ì¬ì ‘ì† ì²˜ë¦¬
            useEffect(() => {
                if (!roomId) return;

                const roomRef = db.ref(`rooms/${roomId}`);
                const playerRef = db.ref(`rooms/${roomId}/players/${userId}`);
                const connectedRef = db.ref('.info/connected');

                const handleConnection = (snap) => {
                    if (snap.val() === true) {
                        playerRef.update({ 
                            isConnected: true, 
                            lastSeen: firebase.database.ServerValue.TIMESTAMP 
                        });
                        playerRef.onDisconnect().update({ 
                            isConnected: false, 
                            lastSeen: firebase.database.ServerValue.TIMESTAMP 
                        });
                    }
                };

                connectedRef.on('value', handleConnection);

                const roomListener = roomRef.on('value', (snap) => {
                    const data = snap.val();
                    if (!data) {
                        alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                        handleLeave();
                        return;
                    }
                    setRoomData(data);
                    
                    // ë°©ì¥ ì´íƒˆ ì‹œ ìë™ ìœ„ì„
                    if (data.hostId && !data.players[data.hostId]) {
                        const playerIds = Object.keys(data.players);
                        if (playerIds.length > 0) {
                            const newHost = playerIds[0];
                            roomRef.update({ hostId: newHost });
                        }
                    }
                });

                const msgRef = db.ref(`rooms/${roomId}/messages`).limitToLast(50);
                const msgListener = msgRef.on('value', (snap) => {
                    setMessages(snap.val() ? Object.values(snap.val()) : []);
                });

                return () => {
                    connectedRef.off('value', handleConnection);
                    roomRef.off('value', roomListener);
                    msgRef.off('value', msgListener);
                    playerRef.onDisconnect().cancel();
                };
            }, [roomId, userId]);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const handleCreate = async () => {
                if (!nickname.trim()) return setError('ë‹‰ë„¤ì„ í•„ìˆ˜');
                const code = genCode();
                try {
                    await db.ref(`rooms/${code}`).set({
                        hostId: userId,
                        status: 'waiting',
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        settings: { gameTime: 480, turnTime: 40 },
                        players: {
                            [userId]: {
                                name: nickname,
                                role: null,
                                isSpy: false,
                                isConnected: true,
                                lastSeen: firebase.database.ServerValue.TIMESTAMP
                            }
                        }
                    });
                    setRoomId(code);
                    setView('room');
                } catch (e) {
                    setError('ë°© ìƒì„± ì‹¤íŒ¨');
                }
            };

            const handleJoin = async () => {
                if (!nickname.trim() || !roomId.trim()) return setError('ì •ë³´ ì…ë ¥ í•„ìˆ˜');
                const code = roomId.toUpperCase();
                try {
                    const snap = await db.ref(`rooms/${code}`).once('value');
                    if (!snap.exists()) return setError('ì—†ëŠ” ë°©');
                    
                    await db.ref(`rooms/${code}/players/${userId}`).set({
                        name: nickname,
                        role: null,
                        isSpy: false,
                        isConnected: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    setRoomId(code);
                    setView('room');
                } catch (e) {
                    setError('ì ‘ì† ì‹¤íŒ¨');
                }
            };

            const handleStart = async () => {
                const players = Object.values(roomData.players);
                if (players.length < 3) return alert('ìµœì†Œ 3ëª… í•„ìš”');

                const locKeys = Object.keys(LOCATIONS);
                const randomLoc = LOCATIONS[locKeys[Math.floor(Math.random() * locKeys.length)]];
                const roles = [...randomLoc.roles];
                const spyIdx = Math.floor(Math.random() * players.length);

                const updated = {};
                players.forEach((p, i) => {
                    updated[p.uid || Object.keys(roomData.players)[i]] = {
                        ...p,
                        role: i === spyIdx ? 'SPY' : (roles.pop() || 'ì‹œë¯¼'),
                        isSpy: i === spyIdx
                    };
                });

                await db.ref(`rooms/${roomId}`).update({
                    status: 'playing',
                    location: randomLoc.name,
                    players: updated,
                    gameStart: firebase.database.ServerValue.TIMESTAMP,
                    currentTurn: players[0].uid || Object.keys(updated)[0]
                });
            };

            const handleEnd = async () => {
                await db.ref(`rooms/${roomId}`).update({ 
                    status: 'finished',
                    endTime: firebase.database.ServerValue.TIMESTAMP 
                });
            };

            const handleRestart = async () => {
                const resetPlayers = {};
                Object.keys(roomData.players).forEach(pid => {
                    resetPlayers[pid] = {
                        ...roomData.players[pid],
                        role: null,
                        isSpy: false
                    };
                });
                
                await db.ref(`rooms/${roomId}`).update({
                    status: 'waiting',
                    location: null,
                    players: resetPlayers,
                    gameStart: null,
                    currentTurn: null
                });
                
                await db.ref(`rooms/${roomId}/messages`).remove();
            };

            const handleLeave = async () => {
                if (roomId) {
                    await db.ref(`rooms/${roomId}/players/${userId}`).remove();
                }
                setRoomId('');
                setRoomData(null);
                setMessages([]);
                setView('lobby');
            };

            const sendMsg = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                
                await db.ref(`rooms/${roomId}/messages`).push({
                    sender: nickname,
                    text: chatInput,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                setChatInput('');
            };

            const copyCode = () => {
                navigator.clipboard?.writeText(roomId).then(() => alert('ë³µì‚¬ë¨')).catch(() => prompt('ë°© ì½”ë“œ:', roomId));
            };

            // UI ë Œë”ë§
            if (view === 'lobby') {
                return (
                    <div className="app-container bg-gradient-to-br from-purple-900 via-gray-900 to-black flex items-center justify-center p-4">
                        <div className="glass rounded-3xl p-6 w-full max-w-md">
                            <div className="text-center mb-6">
                                <div className="text-6xl mb-3">ğŸ•µï¸</div>
                                <h1 className="text-4xl font-black">SPYFALL</h1>
                            </div>

                            <input
                                value={nickname}
                                onChange={e => setNickname(e.target.value)}
                                placeholder="ë‹‰ë„¤ì„ ì…ë ¥"
                                className="w-full bg-black/50 border border-white/20 rounded-xl px-4 py-3 mb-4 text-white"
                            />

                            {error && <div className="bg-red-500/20 text-red-300 p-3 rounded-xl mb-4 text-sm">{error}</div>}

                            <button
                                onClick={handleCreate}
                                className="w-full bg-purple-600 hover:bg-purple-500 py-4 rounded-xl font-bold mb-3"
                            >
                                ë°© ë§Œë“¤ê¸°
                            </button>

                            <div className="flex gap-2">
                                <input
                                    value={roomId}
                                    onChange={e => setRoomId(e.target.value.toUpperCase())}
                                    placeholder="ë°© ì½”ë“œ"
                                    maxLength={4}
                                    className="flex-1 bg-black/50 border border-white/20 rounded-xl px-4 py-3 text-white text-center uppercase"
                                />
                                <button
                                    onClick={handleJoin}
                                    className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold"
                                >
                                    ì…ì¥
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!roomData) {
                return <div className="app-container bg-black flex items-center justify-center">
                    <div className="text-white">ë¡œë”© ì¤‘...</div>
                </div>;
            }

            const players = Object.values(roomData.players || {});
            const me = roomData.players[userId];
            const isHost = roomData.hostId === userId;
            const isPlaying = roomData.status === 'playing';
            const isFinished = roomData.status === 'finished';

            return (
                <div className="app-container bg-gradient-to-br from-gray-900 to-black">
                    {/* ìƒë‹¨ ì•¡ì…˜ í—¤ë” */}
                    {isPlaying && me && (
                        <div className="action-header bg-gradient-to-r from-purple-600 to-pink-600 p-4 text-center">
                            <div className="text-2xl font-black mb-1">
                                {me.isSpy ? 'ğŸ•µï¸ ë‹¹ì‹ ì€ ìŠ¤íŒŒì´!' : 'ğŸ­ ì¥ì†Œë¥¼ ì§€ì¼œë¼'}
                            </div>
                            <div className="text-sm opacity-90">
                                {me.isSpy ? 'ì¥ì†Œë¥¼ ì¶”ë¡ í•˜ì„¸ìš”' : `ì¥ì†Œ: ${roomData.location}`}
                            </div>
                        </div>
                    )}

                    {/* ë°© ì •ë³´ */}
                    <div className="glass m-4 p-4 rounded-2xl flex justify-between items-center">
                        <div>
                            <div className="text-xs text-gray-400">ë°© ì½”ë“œ</div>
                            <div className="text-2xl font-black">{roomId}</div>
                        </div>
                        <div className="flex gap-2">
                            {isPlaying && (
                                <button
                                    onClick={() => setShowLocations(true)}
                                    className="bg-yellow-600 hover:bg-yellow-500 px-4 py-2 rounded-xl text-sm font-bold"
                                >
                                    ì¥ì†Œëª©ë¡
                                </button>
                            )}
                            <button onClick={copyCode} className="bg-white/10 px-4 py-2 rounded-xl text-sm">ë³µì‚¬</button>
                            <button onClick={handleLeave} className="bg-red-600 hover:bg-red-500 px-4 py-2 rounded-xl text-sm">ë‚˜ê°€ê¸°</button>
                        </div>
                    </div>

                    {/* í”Œë ˆì´ì–´ ëª©ë¡ */}
                    <div className="glass mx-4 mb-4 p-4 rounded-2xl">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {players.map(p => (
                                <div
                                    key={p.uid || p.name}
                                    className={`p-3 rounded-xl text-center ${
                                        p.isConnected ? 'bg-green-900/30 border border-green-500/30' : 'bg-red-900/30 border border-red-500/30'
                                    }`}
                                >
                                    <div className="font-bold">{p.name}</div>
                                    {!p.isConnected && <div className="text-xs text-red-400">ì—°ê²° ëŠê¹€</div>}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* ì±„íŒ… ì˜ì—­ */}
                    <div className="flex-1 overflow-hidden px-4">
                        <div className="glass rounded-2xl h-full flex flex-col">
                            <div className="chat-area p-4">
                                {messages.map((msg, i) => (
                                    <div key={i} className="mb-3">
                                        <div className="text-xs text-gray-400 mb-1">{msg.sender}</div>
                                        <div className="bg-white/10 rounded-xl p-3">{msg.text}</div>
                                    </div>
                                ))}
                                <div ref={chatEndRef} />
                            </div>
                        </div>
                    </div>

                    {/* ì±„íŒ… ì…ë ¥ (ê³ ì •) */}
                    <form onSubmit={sendMsg} className="chat-input-fixed p-4">
                        <div className="max-w-5xl mx-auto flex gap-2">
                            <input
                                value={chatInput}
                                onChange={e => setChatInput(e.target.value)}
                                placeholder="ë©”ì‹œì§€ ì…ë ¥..."
                                className="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white"
                            />
                            <button
                                type="submit"
                                className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold"
                            >
                                ì „ì†¡
                            </button>
                        </div>
                    </form>

                    {/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */}
                    <div className="p-4 bg-black/50">
                        {!isPlaying && !isFinished && isHost && (
                            <button
                                onClick={handleStart}
                                disabled={players.length < 3}
                                className="w-full bg-green-600 hover:bg-green-500 disabled:bg-gray-700 py-4 rounded-xl font-bold text-lg"
                            >
                                ê²Œì„ ì‹œì‘ ({players.length}/3)
                            </button>
                        )}
                        {isPlaying && isHost && (
                            <button
                                onClick={handleEnd}
                                className="w-full bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold"
                            >
                                ê²Œì„ ì¢…ë£Œ
                            </button>
                        )}
                        {isFinished && isHost && (
                            <button
                                onClick={handleRestart}
                                className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold"
                            >
                                ìƒˆ ê²Œì„ ì‹œì‘
                            </button>
                        )}
                    </div>

                    {/* ì¥ì†Œ ëª©ë¡ ëª¨ë‹¬ */}
                    {showLocations && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50" onClick={() => setShowLocations(false)}>
                            <div className="glass rounded-3xl p-6 max-w-md w-full max-h-[80vh] overflow-auto" onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-bold mb-4">ì¥ì†Œ ëª©ë¡</h2>
                                <div className="space-y-2">
                                    {Object.values(LOCATIONS).map(loc => (
                                        <label key={loc.name} className="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10">
                                            <input
                                                type="checkbox"
                                                checked={checkedLocations[loc.name]}
                                                onChange={e => setCheckedLocations({...checkedLocations, [loc.name]: e.target.checked})}
                                                className="w-5 h-5"
                                            />
                                            <span className={checkedLocations[loc.name] ? 'line-through opacity-50' : ''}>{loc.name}</span>
                                        </label>
                                    ))}
                                </div>
                                <button
                                    onClick={() => setShowLocations(false)}
                                    className="w-full mt-4 bg-white/10 py-3 rounded-xl font-bold"
                                >
                                    ë‹«ê¸°
                                </button>
                            </div>
                        </div>
                    )}

                    {/* ê²°ê³¼ ëª¨ë‹¬ */}
                    {isFinished && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
                            <div className="glass rounded-3xl p-6 max-w-md w-full">
                                <h2 className="text-3xl font-black text-center mb-4">ê²Œì„ ì¢…ë£Œ</h2>
                                <div className="text-center mb-4">
                                    <div className="text-sm text-gray-400">ì¥ì†Œ</div>
                                    <div className="text-2xl font-bold">{roomData.location}</div>
                                </div>
                                <div className="space-y-2 mb-6">
                                    {players.map(p => (
                                        <div
                                            key={p.uid || p.name}
                                            className={`p-3 rounded-xl flex justify-between ${
                                                p.isSpy ? 'bg-red-900/40 border border-red-500' : 'bg-white/5'
                                            }`}
                                        >
                                            <span className="font-bold">{p.name}</span>
                                            <span>{p.isSpy ? 'ğŸ•µï¸ ìŠ¤íŒŒì´' : p.role}</span>
                                        </div>
                                    ))}
                                </div>
                                {isHost && (
                                    <button
                                        onClick={handleRestart}
                                        className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold"
                                    >
                                        ë‹¤ì‹œ ì‹œì‘
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>